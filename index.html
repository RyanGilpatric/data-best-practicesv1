<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Data Best Practices — Interactive Guide (Ultra v4.0)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="dark light">
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{ 
      --bg:#080c14; --bg-2:#0a1019; --panel:#0d1520; --glass: rgba(255,255,255,.04);
      --text:#e8ecf4; --muted:#7a8599; --brand:#3b82f6; --brand-2:#06b6d4; --accent:#10b981; --danger:#ef4444; --amber:#f59e0b; --purple:#8b5cf6; --border:#1e293b;
      --shadow-lg: 0 25px 50px -12px rgba(0,0,0,.5); --shadow-md: 0 10px 25px rgba(0,0,0,.3); --max: 1280px;
      --font-display: 'Outfit', system-ui, sans-serif;
      --font-mono: 'JetBrains Mono', ui-monospace, monospace;
    }
    :root[data-theme='light']{ 
      --bg:#f8fafc; --bg-2:#f1f5f9; --panel:#ffffff; --glass: rgba(15,23,42,.04); 
      --text:#0f172a; --muted:#64748b; --border:#e2e8f0; 
      --shadow-lg:0 25px 50px -12px rgba(15,23,42,.15); --shadow-md:0 10px 25px rgba(15,23,42,.08); 
    }
    *{ box-sizing: border-box; margin:0; } html, body{ height:100%; }
    body{ 
      color:var(--text); 
      background: var(--bg);
      font-family: var(--font-display); 
      font-weight: 400;
      line-height:1.6; 
      letter-spacing:.01em; 
      overflow-y:overlay; 
    }
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background: 
        radial-gradient(ellipse 80% 50% at 20% -20%, rgba(59,130,246,.15), transparent),
        radial-gradient(ellipse 60% 40% at 80% 10%, rgba(6,182,212,.12), transparent),
        radial-gradient(ellipse 50% 50% at 50% 100%, rgba(139,92,246,.08), transparent);
      pointer-events: none;
      z-index: -1;
    }
    ::selection{ background: rgba(59,130,246,.35); } 
    a{ color:inherit; text-decoration:none; }
    
    /* Layout */
    .shell{ min-height:100dvh; display:grid; grid-template-columns: 300px 1fr; }
    .left{ 
      position: sticky; top:0; height:100dvh; overflow:auto; 
      background: var(--panel);
      border-right:1px solid var(--border); 
      display: flex;
      flex-direction: column;
    }
    .center{ min-width:0; display:flex; flex-direction:column; }
    
    /* Sidebar */
    .brand{ display:flex; align-items:center; gap:12px; padding: 20px 20px 6px; } 
    .brand h1{ font-size:17px; margin:0; font-weight:600; letter-spacing:-.01em; }
    .note{ color:var(--muted); font-size:12px; padding:0 20px 12px; line-height:1.5; }
    .search{ 
      margin:4px 14px 16px; display:flex; align-items:center; gap:10px; 
      background:var(--bg); border:1px solid var(--border); 
      padding:10px 14px; border-radius:10px; 
      transition: border-color .15s, box-shadow .15s;
    }
    .search:focus-within { border-color: var(--brand); box-shadow: 0 0 0 3px rgba(59,130,246,.15); }
    .search input{ flex:1; background:transparent; border:0; color:var(--text); outline:none; font-family: inherit; font-size:14px; }
    .search input::placeholder { color: var(--muted); }
    
    .nav-section { padding: 0 8px; margin-bottom: 8px; }
    .nav-label { 
      font-size: 11px; 
      font-weight: 600; 
      text-transform: uppercase; 
      letter-spacing: .08em; 
      color: var(--muted); 
      padding: 12px 12px 6px;
    }
    .navlink{ 
      display:flex; align-items:center; gap:10px; 
      padding:9px 12px; margin:2px 0; border-radius:8px; 
      border:1px solid transparent; color:var(--text); 
      font-size: 14px;
      transition: all .15s;
    }
    .navlink:hover{ background: var(--glass); color: var(--brand); }
    .navlink.active{ 
      background: linear-gradient(135deg, rgba(59,130,246,.15), rgba(6,182,212,.1)); 
      border-color: rgba(59,130,246,.2);
      color: var(--brand);
    }
    .navlink i { width: 18px; height: 18px; opacity: .7; }
    .navlink.active i { opacity: 1; }
    
    .section{ margin:2px 8px; border-radius:8px; overflow:hidden; }
    .section > button{ 
      width:100%; text-align:left; background:transparent; 
      border:0; color:var(--text); padding:9px 12px; 
      display:flex; align-items:center; gap:10px; 
      cursor:pointer; font-family: inherit; font-size: 14px;
      border-radius: 8px;
      transition: all .15s;
    }
    .section > button:hover{ background: var(--glass); }
    .section > button i { width: 18px; height: 18px; opacity: .7; }
    .subnav{ display:none; padding: 2px 0 6px; }
    .subnav a{ 
      display:block; padding:7px 12px 7px 40px; 
      color:var(--muted); font-size: 13px;
      border-radius: 6px;
      margin: 1px 4px;
      transition: all .15s;
    }
    .subnav a:hover{ background: var(--glass); color:var(--text); }
    .subnav a.active { background: rgba(59,130,246,.1); color: var(--brand); }
    
    .side-footer { margin-top: auto; padding: 16px; border-top: 1px solid var(--border); }
    .side-cta{ display:flex; gap:6px; margin-bottom: 12px; }
    .btn{ 
      display:inline-flex; align-items:center; justify-content: center; gap:6px; 
      background: var(--glass); color:var(--text); 
      border:1px solid var(--border); border-radius:8px; 
      padding:7px 12px; cursor:pointer; 
      font-family: inherit; font-size: 13px; font-weight: 500;
      transition: all .15s;
    }
    .btn:hover { background: var(--bg); border-color: var(--brand); }
    .btn.primary { background: var(--brand); border-color: var(--brand); color: white; }
    .btn.primary:hover { background: #2563eb; }
    .btn.success { background: var(--accent); border-color: var(--accent); color: white; }
    .btn.ghost{ background:transparent; border-color: transparent; }
    .btn.ghost:hover { background: var(--glass); border-color: var(--border); }
    .btn i { width: 16px; height: 16px; }
    
    .kbd{ 
      font-family: var(--font-mono); font-size:11px; 
      padding:2px 6px; border:1px solid var(--border); 
      border-bottom-width:2px; border-radius:5px; 
      background: var(--bg); color:var(--muted); 
    }
    
    /* Top bar */
    .top{ 
      position: sticky; top:0; z-index:10; 
      backdrop-filter:saturate(140%) blur(12px); 
      background: linear-gradient(180deg, rgba(8,12,20,.9), rgba(8,12,20,.7));
      border-bottom:1px solid var(--border); 
    }
    :root[data-theme='light'] .top { background: linear-gradient(180deg, rgba(248,250,252,.95), rgba(248,250,252,.8)); }
    .container{ width:100%; max-width: var(--max); margin:0 auto; padding: 0 28px; }
    .topbar{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px 0; }
    .crumbs{ display:flex; align-items:center; gap:8px; color:var(--muted); font-size:13px; }
    .crumbs i { width: 14px; height: 14px; }
    
    /* Hero */
    .hero{ padding:24px 0 8px; }
    .heroCard{ 
      background: linear-gradient(135deg, var(--glass), transparent);
      border:1px solid var(--border); 
      border-radius:16px; padding:20px; 
      display:flex; align-items:center; gap:16px; 
    }
    .heroIcon{ 
      width:52px; height:52px; border-radius:14px; 
      display:grid; place-items:center; 
      background: linear-gradient(135deg, rgba(59,130,246,.2), rgba(6,182,212,.15));
      border:1px solid rgba(59,130,246,.25); 
    }
    .heroIcon i { width: 24px; height: 24px; color: var(--brand); }
    .hero h2{ margin:0; font-size: clamp(22px, 3vw, 30px); font-weight: 600; letter-spacing:-.02em; }
    .hero p{ margin:4px 0 0; color:var(--muted); font-size: 14px; }
    
    /* Main content */
    .main{ padding:20px 0 60px; } 
    .content{ display:grid; gap:20px; }
    
    /* Cards */
    .card{ 
      background: var(--panel);
      border:1px solid var(--border); 
      border-radius:14px; padding:20px; 
      box-shadow: var(--shadow-md);
    }
    .card.tool { 
      background: linear-gradient(135deg, rgba(59,130,246,.05), rgba(139,92,246,.03));
      border-color: rgba(59,130,246,.15);
    }
    .card.result {
      background: linear-gradient(135deg, rgba(16,185,129,.08), rgba(6,182,212,.05));
      border-color: rgba(16,185,129,.2);
    }
    .card.warning {
      background: linear-gradient(135deg, rgba(245,158,11,.08), rgba(239,68,68,.05));
      border-color: rgba(245,158,11,.2);
    }
    
    .callout{ 
      border-left:3px solid var(--amber); 
      padding:14px 16px; 
      background: rgba(245,158,11,.08); 
      border-radius:0 10px 10px 0; 
      font-size: 14px;
    }
    .callout.info { border-left-color: var(--brand); background: rgba(59,130,246,.08); }
    .callout.success { border-left-color: var(--accent); background: rgba(16,185,129,.08); }
    .callout.danger { border-left-color: var(--danger); background: rgba(239,68,68,.08); }
    
    h3{ margin:20px 0 10px; color:var(--brand-2); letter-spacing:.03em; text-transform:uppercase; font-size:13px; font-weight: 600; }
    h3:first-child { margin-top: 0; }
    h4{ margin:16px 0 8px; font-size:15px; font-weight: 600; }
    p { margin: 0 0 12px; }
    p:last-child { margin-bottom: 0; }
    
    ol, ul{ padding-left:20px; margin: 8px 0; }
    li { margin: 4px 0; }
    li::marker { color: var(--muted); }
    
    .table{ width:100%; border-collapse:collapse; border:1px solid var(--border); border-radius: 8px; overflow: hidden; font-size: 14px; }
    .table th, .table td{ border:1px solid var(--border); padding:10px 12px; text-align:left; }
    .table th { background: var(--bg); font-weight: 600; font-size: 12px; text-transform: uppercase; letter-spacing: .05em; color: var(--muted); }
    .table td { background: var(--panel); }
    
    .muted{ color:var(--muted); } 
    .ok{ color:var(--accent); } 
    .danger{ color:var(--danger); } 
    .brand { color: var(--brand); }
    mark{ background: rgba(245,158,11,.3); color: inherit; padding:1px 4px; border-radius:3px; }
    code { font-family: var(--font-mono); font-size: .9em; background: var(--bg); padding: 2px 6px; border-radius: 4px; }
    
    /* Progress bar */
    .progress{ position:fixed; top:0; left:0; height:2px; background:linear-gradient(90deg,var(--brand),var(--brand-2),var(--purple)); width:0%; z-index:50; }
    
    /* FAB */
    .fab{ position:fixed; bottom:20px; right:20px; display:flex; gap:8px; z-index:40; } 
    .fab .btn{ backdrop-filter: blur(8px); box-shadow: var(--shadow-md); }
    
    /* Command palette */
    .cmdk{ position:fixed; inset:0; display:none; place-items:center; backdrop-filter:blur(8px); background:rgba(8,12,20,.6); z-index:60; }
    :root[data-theme='light'] .cmdk { background: rgba(248,250,252,.7); }
    .cmdk.open{ display:grid; }
    .cmd{ width:min(640px,calc(100% - 32px)); border:1px solid var(--border); border-radius:14px; overflow:hidden; background:var(--panel); box-shadow:var(--shadow-lg); }
    .cmdHead{ display:flex; align-items:center; gap:10px; padding:14px 16px; border-bottom:1px solid var(--border); background:var(--bg); }
    .cmdHead input{ flex:1; background:transparent; border:0; outline:none; color:var(--text); font-size:15px; font-family: inherit; }
    .cmdList{ max-height:50vh; overflow:auto; }
    .cmdItem{ display:flex; align-items:center; gap:12px; padding:12px 16px; border-bottom:1px solid var(--border); cursor:pointer; font-size: 14px; }
    .cmdItem:hover, .cmdItem.active{ background: rgba(59,130,246,.1); }
    .cmdItem i { width: 18px; height: 18px; color: var(--muted); }
    
    /* Mobile */
    .hamb{ position:fixed; top:12px; left:12px; z-index:70; display:none; }
    @media (max-width:900px){ 
      .hamb{ display:block; } 
      .left{ position:fixed; left:0; top:0; transform:translateX(-100%); transition: transform .25s ease; z-index:80; width:88vw; max-width:320px; } 
      .left.open{ transform:translateX(0); } 
      .shell{ grid-template-columns:1fr; } 
      .top{ padding-left:52px; }
      .container { padding: 0 16px; }
    }
    @media print{ 
      .left,.top,.fab,.progress,.hamb{ display:none !important; } 
      .container{ padding:0; } 
      body{ background:white; color:#111; } 
      .card { box-shadow: none; border: 1px solid #ddd; }
    }
    
    /* Forms for tools */
    .form-group { margin-bottom: 16px; }
    .form-group:last-child { margin-bottom: 0; }
    .form-label { display: block; font-size: 13px; font-weight: 500; margin-bottom: 6px; color: var(--text); }
    .form-hint { font-size: 12px; color: var(--muted); margin-top: 4px; }
    .form-input, .form-select, .form-textarea { 
      width: 100%; 
      padding: 10px 14px; 
      background: var(--bg); 
      border: 1px solid var(--border); 
      border-radius: 8px; 
      color: var(--text); 
      font-family: inherit; 
      font-size: 14px;
      transition: border-color .15s, box-shadow .15s;
    }
    .form-input:focus, .form-select:focus, .form-textarea:focus { 
      outline: none; 
      border-color: var(--brand); 
      box-shadow: 0 0 0 3px rgba(59,130,246,.15); 
    }
    .form-textarea { min-height: 100px; resize: vertical; line-height: 1.5; }
    .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
    
    /* Checkbox list */
    .check-list { list-style: none; padding: 0; margin: 0; }
    .check-item { 
      display: flex; align-items: flex-start; gap: 12px; 
      padding: 12px 14px; 
      border: 1px solid var(--border); 
      border-radius: 10px; 
      margin-bottom: 8px;
      background: var(--bg);
      cursor: pointer;
      transition: all .15s;
    }
    .check-item:hover { border-color: var(--brand); }
    .check-item.checked { 
      background: rgba(16,185,129,.08); 
      border-color: rgba(16,185,129,.3); 
    }
    .check-item input[type="checkbox"] { 
      width: 20px; height: 20px; 
      accent-color: var(--accent);
      margin-top: 2px;
      flex-shrink: 0;
    }
    .check-item label { flex: 1; cursor: pointer; }
    .check-item .check-title { font-weight: 500; display: block; margin-bottom: 2px; }
    .check-item .check-desc { font-size: 13px; color: var(--muted); display: block; }
    
    /* Score indicator */
    .score-ring { 
      width: 120px; height: 120px; 
      position: relative; 
      margin: 0 auto 16px;
    }
    .score-ring svg { width: 100%; height: 100%; transform: rotate(-90deg); }
    .score-ring circle { fill: none; stroke-width: 8; }
    .score-ring .bg { stroke: var(--border); }
    .score-ring .fill { stroke: var(--accent); stroke-linecap: round; transition: stroke-dashoffset .5s ease; }
    .score-ring .score-text { 
      position: absolute; 
      inset: 0; 
      display: flex; 
      flex-direction: column;
      align-items: center; 
      justify-content: center; 
      font-size: 32px; 
      font-weight: 700; 
    }
    .score-ring .score-label { font-size: 12px; color: var(--muted); font-weight: 400; }
    
    /* Result panels */
    .result-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin: 16px 0; }
    .result-stat { 
      background: var(--bg); 
      border: 1px solid var(--border); 
      border-radius: 10px; 
      padding: 14px; 
      text-align: center; 
    }
    .result-stat .stat-value { font-size: 24px; font-weight: 700; color: var(--brand); }
    .result-stat .stat-label { font-size: 12px; color: var(--muted); margin-top: 2px; }
    
    /* Challenge questions */
    .challenge-list { list-style: none; padding: 0; margin: 0; }
    .challenge-item { 
      padding: 14px 16px; 
      border-left: 3px solid var(--purple); 
      background: rgba(139,92,246,.08); 
      border-radius: 0 10px 10px 0; 
      margin-bottom: 10px;
      font-size: 14px;
    }
    .challenge-item strong { color: var(--purple); }
    
    /* Export buttons */
    .export-bar { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border); }
    
    /* Traffic light */
    .traffic { display: flex; gap: 8px; align-items: center; }
    .traffic-light { width: 16px; height: 16px; border-radius: 50%; opacity: .3; }
    .traffic-light.active { opacity: 1; box-shadow: 0 0 8px currentColor; }
    .traffic-light.red { background: var(--danger); color: var(--danger); }
    .traffic-light.yellow { background: var(--amber); color: var(--amber); }
    .traffic-light.green { background: var(--accent); color: var(--accent); }

    /* Bias Checker Enhancements */
    .bias-last-saved {
      font-size: 12px;
      color: var(--muted);
      margin-top: 8px;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .bias-last-saved.visible { opacity: 1; }
    .bias-last-saved i { width: 12px; height: 12px; margin-right: 4px; vertical-align: -2px; }

    .check-item-expanded { flex-direction: column; }
    .check-item-header { display: flex; align-items: flex-start; gap: 12px; width: 100%; }
    .check-item-body { width: 100%; margin-top: 0; max-height: 0; overflow: hidden; transition: all 0.3s ease; }
    .check-item.expanded .check-item-body { max-height: 300px; margin-top: 12px; }

    .check-why-toggle {
      font-size: 12px;
      color: var(--brand);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-top: 4px;
      opacity: 0.8;
      transition: opacity 0.15s;
    }
    .check-why-toggle:hover { opacity: 1; }
    .check-why-toggle i { width: 14px; height: 14px; transition: transform 0.2s; }
    .check-item.expanded .check-why-toggle i { transform: rotate(180deg); }

    .check-why-content {
      background: rgba(59, 130, 246, 0.08);
      border-left: 3px solid var(--brand);
      padding: 10px 12px;
      border-radius: 0 8px 8px 0;
      font-size: 13px;
      color: var(--text);
      line-height: 1.5;
      margin-bottom: 12px;
    }
    .check-why-content i { width: 14px; height: 14px; margin-right: 6px; color: var(--brand); vertical-align: -2px; }

    .check-notes-input {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 13px;
      background: var(--bg);
      color: var(--text);
      resize: none;
      min-height: 60px;
      transition: border-color 0.15s;
    }
    .check-notes-input:focus { outline: none; border-color: var(--brand); }
    .check-notes-input::placeholder { color: var(--muted); }
    .check-notes-label { font-size: 11px; color: var(--muted); margin-bottom: 4px; display: block; }

    /* Completion celebration */
    @keyframes celebratePulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    @keyframes confettiFall {
      0% { transform: translateY(-10px) rotate(0deg); opacity: 1; }
      100% { transform: translateY(20px) rotate(360deg); opacity: 0; }
    }
    .score-ring.complete { animation: celebratePulse 0.6s ease-out; }
    .score-ring.complete .fill { filter: drop-shadow(0 0 8px var(--accent)); }
    .completion-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: linear-gradient(135deg, var(--accent), #059669);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      margin-top: 8px;
      animation: fadeIn 0.4s ease;
    }
    .completion-badge i { width: 16px; height: 16px; }

    .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }

    /* Animations */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    .fade-in { animation: fadeIn .3s ease; }

    /* SMART Framework Styles */
    .smart-item {
      display: flex;
      gap: 16px;
      padding: 16px;
      margin-bottom: 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      transition: border-color .15s;
    }
    .smart-item:hover { border-color: rgba(59,130,246,.3); }
    .smart-item:last-child { margin-bottom: 0; }
    .smart-letter {
      width: 44px;
      height: 44px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      font-weight: 700;
      color: white;
      flex-shrink: 0;
      background: linear-gradient(135deg, var(--brand), var(--brand-2));
    }
    .smart-content { flex: 1; min-width: 0; }
    .smart-content h4 { margin: 0 0 6px; display: flex; align-items: center; gap: 8px; }
    .smart-content h4 i { width: 16px; height: 16px; color: var(--muted); }
    .smart-content > p { margin: 0; color: var(--muted); font-size: 14px; }

    /* Example comparison box */
    .example-compare {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 12px;
    }
    @media (max-width: 600px) { .example-compare { grid-template-columns: 1fr; } }
    .example-box {
      padding: 12px 14px;
      border-radius: 8px;
      font-size: 13px;
      line-height: 1.5;
    }
    .example-box.bad {
      background: rgba(239,68,68,.1);
      border: 1px solid rgba(239,68,68,.2);
    }
    .example-box.good {
      background: rgba(16,185,129,.1);
      border: 1px solid rgba(16,185,129,.2);
    }
    .example-box .example-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .05em;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .example-box.bad .example-label { color: var(--danger); }
    .example-box.good .example-label { color: var(--accent); }
    .example-box .example-label i { width: 14px; height: 14px; }

    /* Bias cards */
    .bias-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }
    .bias-card {
      padding: 14px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 10px;
    }
    .bias-card strong { color: var(--amber); font-size: 13px; }
    .bias-card p { margin: 4px 0 0; font-size: 13px; color: var(--muted); }

    /* CTQ link card */
    .link-card {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 16px;
      background: linear-gradient(135deg, rgba(59,130,246,.08), rgba(139,92,246,.05));
      border: 1px solid rgba(59,130,246,.2);
      border-radius: 12px;
      cursor: pointer;
      transition: all .15s;
    }
    .link-card:hover {
      border-color: var(--brand);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(59,130,246,.15);
    }
    .link-card-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(59,130,246,.15);
    }
    .link-card-icon i { width: 20px; height: 20px; color: var(--brand); }
    .link-card-content { flex: 1; }
    .link-card-content strong { display: block; margin-bottom: 2px; }
    .link-card-content span { font-size: 13px; color: var(--muted); }
    .link-card-arrow { color: var(--muted); }
    .link-card-arrow i { width: 20px; height: 20px; }

    /* Principle callout */
    .principle-box {
      display: flex;
      gap: 16px;
      padding: 20px;
      background: linear-gradient(135deg, rgba(16,185,129,.1), rgba(6,182,212,.05));
      border: 1px solid rgba(16,185,129,.2);
      border-radius: 14px;
      margin-bottom: 20px;
    }
    .principle-box-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(16,185,129,.15);
      flex-shrink: 0;
    }
    .principle-box-icon i { width: 24px; height: 24px; color: var(--accent); }
    .principle-box-content { flex: 1; }
    .principle-box-content strong { color: var(--accent); font-size: 13px; text-transform: uppercase; letter-spacing: .05em; }
    .principle-box-content p { margin: 6px 0 0; }

    /* Practice cards grid */
    .practice-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin: 12px 0 20px;
    }
    .practice-card {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 14px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      transition: border-color .15s;
    }
    .practice-card:hover { border-color: rgba(59,130,246,.3); }
    .practice-card-icon {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(59,130,246,.1);
      flex-shrink: 0;
    }
    .practice-card-icon i { width: 18px; height: 18px; color: var(--brand); }
    .practice-card-content strong { display: block; font-size: 13px; margin-bottom: 4px; }
    .practice-card-content span { font-size: 13px; color: var(--muted); }

    /* Checklist with visual checkboxes */
    .checklist-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 8px;
      margin-top: 12px;
    }
    .checklist-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 13px;
      transition: all .15s;
    }
    .checklist-item:hover { border-color: rgba(16,185,129,.3); }
    .checklist-item i { width: 18px; height: 18px; color: var(--accent); flex-shrink: 0; }

    /* Warning/Error cards */
    .error-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 12px;
    }
    .error-card {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 14px 16px;
      background: rgba(239,68,68,.06);
      border: 1px solid rgba(239,68,68,.15);
      border-left: 3px solid var(--danger);
      border-radius: 0 10px 10px 0;
    }
    .error-card i { width: 18px; height: 18px; color: var(--danger); flex-shrink: 0; margin-top: 2px; }
    .error-card-content { flex: 1; }
    .error-card-content strong { color: var(--danger); font-size: 13px; }
    .error-card-content p { margin: 4px 0 0; font-size: 13px; color: var(--muted); }

    /* Context type cards */
    .context-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }
    .context-card {
      padding: 16px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      border-left: 3px solid var(--brand);
      transition: border-color .15s;
    }
    .context-card:hover { border-color: var(--brand); }
    .context-card-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    .context-card-header i { width: 18px; height: 18px; color: var(--brand); }
    .context-card-header strong { font-size: 14px; color: var(--text); }
    .context-card p { margin: 0; font-size: 13px; color: var(--muted); font-style: italic; }

    /* Threshold table */
    .threshold-table {
      width: 100%;
      margin-top: 12px;
      border-collapse: separate;
      border-spacing: 0;
    }
    .threshold-table th,
    .threshold-table td {
      padding: 12px 14px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    .threshold-table th {
      background: var(--bg);
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .05em;
      color: var(--muted);
    }
    .threshold-table th:first-child { border-radius: 8px 0 0 0; }
    .threshold-table th:last-child { border-radius: 0 8px 0 0; }
    .threshold-table td { background: var(--panel); font-size: 13px; }
    .threshold-table tr:last-child td { border-bottom: none; }
    .threshold-table tr:last-child td:first-child { border-radius: 0 0 0 8px; }
    .threshold-table tr:last-child td:last-child { border-radius: 0 0 8px 0; }
    .threshold-normal { color: var(--accent); }
    .threshold-warning { color: var(--amber); }
    .threshold-action { color: var(--danger); }

    /* Seasonality timeline */
    .season-timeline {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 8px;
      margin-top: 12px;
    }
    .season-item {
      padding: 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      text-align: center;
      font-size: 12px;
    }
    .season-item .season-month {
      font-weight: 600;
      color: var(--text);
      margin-bottom: 4px;
    }
    .season-item .season-label {
      color: var(--muted);
      font-size: 11px;
    }
    .season-item.surge { border-color: rgba(239,68,68,.3); background: rgba(239,68,68,.05); }
    .season-item.surge .season-month { color: var(--danger); }
    .season-item.uptick { border-color: rgba(245,158,11,.3); background: rgba(245,158,11,.05); }
    .season-item.uptick .season-month { color: var(--amber); }
    .season-item.baseline { border-color: rgba(16,185,129,.3); background: rgba(16,185,129,.05); }
    .season-item.baseline .season-month { color: var(--accent); }
    .season-item.low { border-color: rgba(59,130,246,.3); background: rgba(59,130,246,.05); }
    .season-item.low .season-month { color: var(--brand); }

    /* Numbered principle headers */
    .principle-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }
    .principle-number {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 700;
      color: white;
      background: linear-gradient(135deg, var(--brand), var(--brand-2));
      flex-shrink: 0;
    }
    .principle-header h3 { margin: 0; }

    /* Bias detection cards */
    .bias-category {
      margin-bottom: 16px;
    }
    .bias-category:last-child { margin-bottom: 0; }
    .bias-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }
    .bias-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .bias-icon i { width: 20px; height: 20px; }
    .bias-icon.cherry { background: rgba(239,68,68,.12); }
    .bias-icon.cherry i { color: var(--danger); }
    .bias-icon.confirm { background: rgba(245,158,11,.12); }
    .bias-icon.confirm i { color: var(--amber); }
    .bias-icon.sample { background: rgba(139,92,246,.12); }
    .bias-icon.sample i { color: var(--purple); }
    .bias-icon.recency { background: rgba(59,130,246,.12); }
    .bias-icon.recency i { color: var(--brand); }
    .bias-header-content h4 { margin: 0 0 2px; font-size: 15px; }
    .bias-header-content p { margin: 0; font-size: 12px; color: var(--muted); }

    /* Bias question items */
    .bias-questions {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .bias-question {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 12px 14px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      transition: all .15s;
    }
    .bias-question:hover { border-color: rgba(139,92,246,.3); background: rgba(139,92,246,.03); }
    .bias-question i { width: 18px; height: 18px; color: var(--purple); flex-shrink: 0; margin-top: 1px; }

    /* Phase 5: Part headers */
    .part-header {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }
    .part-badge {
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .05em;
    }
    .part-badge.improve { background: rgba(16,185,129,.15); color: var(--accent); }
    .part-badge.control { background: rgba(59,130,246,.15); color: var(--brand); }
    .part-header h3 { margin: 0; font-size: 16px; text-transform: none; letter-spacing: normal; color: var(--text); }

    /* Documentation fields */
    .doc-fields {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
    }
    .doc-field {
      padding: 14px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      border-left: 3px solid var(--accent);
    }
    .doc-field h4 {
      margin: 0 0 6px;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .doc-field h4 i { width: 14px; height: 14px; color: var(--accent); }
    .doc-field p { margin: 0; font-size: 12px; color: var(--muted); }

    /* Alert cards */
    .alert-grid {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin: 12px 0;
    }
    .alert-card {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 14px 16px;
      border-radius: 10px;
      font-size: 13px;
    }
    .alert-card.yellow {
      background: rgba(245,158,11,.08);
      border: 1px solid rgba(245,158,11,.2);
    }
    .alert-card.red {
      background: rgba(239,68,68,.08);
      border: 1px solid rgba(239,68,68,.2);
    }
    .alert-card.pattern {
      background: rgba(139,92,246,.08);
      border: 1px solid rgba(139,92,246,.2);
    }
    .alert-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
      margin-top: 4px;
    }
    .alert-card.yellow .alert-indicator { background: var(--amber); box-shadow: 0 0 8px var(--amber); }
    .alert-card.red .alert-indicator { background: var(--danger); box-shadow: 0 0 8px var(--danger); }
    .alert-card.pattern .alert-indicator { background: var(--purple); box-shadow: 0 0 8px var(--purple); }
    .alert-card strong { display: block; margin-bottom: 2px; }
    .alert-card.yellow strong { color: var(--amber); }
    .alert-card.red strong { color: var(--danger); }
    .alert-card.pattern strong { color: var(--purple); }
    .alert-card span { color: var(--muted); }

    /* Case study card */
    .case-study {
      background: linear-gradient(135deg, rgba(16,185,129,.06), rgba(6,182,212,.03));
      border: 1px solid rgba(16,185,129,.15);
      border-radius: 14px;
      overflow: hidden;
    }
    .case-study-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px 20px;
      background: rgba(16,185,129,.08);
      border-bottom: 1px solid rgba(16,185,129,.1);
    }
    .case-study-header i { width: 20px; height: 20px; color: var(--accent); }
    .case-study-header h3 { margin: 0; color: var(--accent); font-size: 14px; }
    .case-study-body { padding: 20px; }
    .case-study-item {
      display: flex;
      gap: 12px;
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
      font-size: 13px;
    }
    .case-study-item:last-child { border-bottom: none; }
    .case-study-item strong { min-width: 120px; color: var(--text); flex-shrink: 0; }
    .case-study-item span { color: var(--muted); }

    /* Control plan elements */
    .control-elements {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin: 12px 0;
    }
    .control-element {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 13px;
    }
    .control-element i { width: 18px; height: 18px; color: var(--brand); flex-shrink: 0; }

    /* Confidence interval visualization */
    .ci-visual {
      margin: 20px 0;
      padding: 20px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 12px;
    }
    .ci-bar-container {
      position: relative;
      height: 40px;
      background: linear-gradient(90deg, rgba(239,68,68,.1), rgba(245,158,11,.1) 25%, rgba(16,185,129,.1) 50%, rgba(245,158,11,.1) 75%, rgba(239,68,68,.1));
      border-radius: 8px;
      margin: 16px 0;
      overflow: hidden;
    }
    .ci-bar-range {
      position: absolute;
      top: 0;
      height: 100%;
      background: linear-gradient(90deg, var(--brand), var(--brand-2));
      border-radius: 8px;
      opacity: 0.9;
    }
    .ci-bar-marker {
      position: absolute;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 12px;
      height: 12px;
      background: white;
      border: 3px solid var(--brand);
      border-radius: 50%;
      z-index: 2;
    }
    .ci-bar-labels {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: var(--muted);
      margin-top: 8px;
    }
    .ci-stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-top: 16px;
    }
    @media (max-width: 600px) { .ci-stats { grid-template-columns: repeat(2, 1fr); } }
    .ci-stat {
      text-align: center;
      padding: 12px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 8px;
    }
    .ci-stat-value {
      font-size: 20px;
      font-weight: 700;
      color: var(--brand);
    }
    .ci-stat-value.lower { color: var(--amber); }
    .ci-stat-value.upper { color: var(--amber); }
    .ci-stat-value.observed { color: var(--accent); }
    .ci-stat-label {
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
      text-transform: uppercase;
      letter-spacing: .03em;
    }

    /* Assessment badges */
    .assessment-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
    }
    .assessment-badge i { width: 18px; height: 18px; }
    .assessment-badge.excellent {
      background: rgba(16,185,129,.12);
      color: var(--accent);
      border: 1px solid rgba(16,185,129,.25);
    }
    .assessment-badge.good {
      background: rgba(59,130,246,.12);
      color: var(--brand);
      border: 1px solid rgba(59,130,246,.25);
    }
    .assessment-badge.moderate {
      background: rgba(245,158,11,.12);
      color: var(--amber);
      border: 1px solid rgba(245,158,11,.25);
    }
    .assessment-badge.low {
      background: rgba(239,68,68,.12);
      color: var(--danger);
      border: 1px solid rgba(239,68,68,.25);
    }

    /* Form with icons */
    .form-label-icon {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .form-label-icon i { width: 14px; height: 14px; color: var(--muted); }

    /* Challenge Mode enhancements */
    .intensity-selector {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
    }
    .intensity-btn {
      flex: 1;
      padding: 12px 16px;
      background: var(--bg);
      border: 2px solid var(--border);
      border-radius: 10px;
      cursor: pointer;
      text-align: center;
      transition: all .15s;
    }
    .intensity-btn:hover { border-color: var(--brand); }
    .intensity-btn.active {
      border-color: var(--brand);
      background: rgba(59,130,246,.1);
    }
    .intensity-btn .intensity-icon { font-size: 20px; margin-bottom: 4px; }
    .intensity-btn .intensity-label { font-weight: 600; font-size: 13px; }
    .intensity-btn .intensity-desc { font-size: 11px; color: var(--muted); margin-top: 2px; }

    .challenge-progress {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      margin-bottom: 16px;
    }
    .challenge-progress-bar {
      flex: 1;
      height: 8px;
      background: var(--border);
      border-radius: 4px;
      overflow: hidden;
    }
    .challenge-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--brand), var(--accent));
      border-radius: 4px;
      transition: width .3s ease;
    }
    .challenge-progress-text {
      font-size: 13px;
      font-weight: 600;
      min-width: 80px;
      text-align: right;
    }

    .challenge-card {
      padding: 16px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      margin-bottom: 10px;
      transition: all .15s;
    }
    .challenge-card:hover { border-color: rgba(139,92,246,.3); }
    .challenge-card.answered {
      border-color: rgba(16,185,129,.3);
      background: rgba(16,185,129,.03);
    }
    .challenge-card.needs-work {
      border-color: rgba(245,158,11,.3);
      background: rgba(245,158,11,.03);
    }
    .challenge-card-header {
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }
    .challenge-card-icon {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .challenge-card-icon i { width: 16px; height: 16px; }
    .challenge-card-icon.data { background: rgba(59,130,246,.12); }
    .challenge-card-icon.data i { color: var(--brand); }
    .challenge-card-icon.bias { background: rgba(245,158,11,.12); }
    .challenge-card-icon.bias i { color: var(--amber); }
    .challenge-card-icon.logic { background: rgba(139,92,246,.12); }
    .challenge-card-icon.logic i { color: var(--purple); }
    .challenge-card-icon.risk { background: rgba(239,68,68,.12); }
    .challenge-card-icon.risk i { color: var(--danger); }
    .challenge-card-icon.context { background: rgba(6,182,212,.12); }
    .challenge-card-icon.context i { color: var(--brand-2); }
    .challenge-card-content { flex: 1; }
    .challenge-card-category {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .05em;
      color: var(--muted);
      margin-bottom: 4px;
    }
    .challenge-card-question {
      font-size: 14px;
      line-height: 1.5;
    }
    .challenge-card-context {
      margin-top: 8px;
      padding: 8px 10px;
      background: rgba(59,130,246,.06);
      border-radius: 6px;
      font-size: 12px;
      color: var(--muted);
    }
    .challenge-card-context a { color: var(--brand); }
    .challenge-card-actions {
      display: flex;
      gap: 6px;
      margin-top: 12px;
    }
    .challenge-action-btn {
      padding: 6px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--panel);
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
      transition: all .15s;
    }
    .challenge-action-btn:hover { border-color: var(--brand); }
    .challenge-action-btn.confident {
      background: rgba(16,185,129,.1);
      border-color: rgba(16,185,129,.3);
      color: var(--accent);
    }
    .challenge-action-btn.needs-work {
      background: rgba(245,158,11,.1);
      border-color: rgba(245,158,11,.3);
      color: var(--amber);
    }
    .challenge-action-btn i { width: 14px; height: 14px; }

    .challenge-summary {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
    }
    .challenge-summary-stat {
      text-align: center;
      padding: 16px;
      background: var(--bg);
      border-radius: 10px;
    }
    .challenge-summary-stat .stat-value { font-size: 24px; font-weight: 700; }
    .challenge-summary-stat .stat-label { font-size: 11px; color: var(--muted); margin-top: 4px; text-transform: uppercase; }
    .challenge-summary-stat.confident .stat-value { color: var(--accent); }
    .challenge-summary-stat.needs-work .stat-value { color: var(--amber); }
    .challenge-summary-stat.unanswered .stat-value { color: var(--muted); }

    .detected-patterns {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 12px;
    }
    .pattern-tag {
      padding: 4px 10px;
      background: rgba(139,92,246,.1);
      border: 1px solid rgba(139,92,246,.2);
      border-radius: 12px;
      font-size: 11px;
      color: var(--purple);
    }
  </style>
</head>
<body>
  <div class="progress" id="progress"></div>
  <button class="hamb btn" aria-label="Open menu" onclick="toggleMenu()"><i data-lucide="menu"></i></button>
  
  <div class="shell">
    <aside class="left" id="leftNav" aria-label="Primary">
      <div class="brand">
        <i data-lucide="sparkles" style="color:var(--brand)"></i>
        <h1>Data Best Practices</h1>
      </div>
      <p class="note">Decision-first framework with bias checks, calculators & interactive tools.</p>
      
      <div class="search">
        <i data-lucide="search" aria-hidden="true"></i>
        <input id="q" placeholder="Search…" oninput="onSearch(this.value)">
      </div>
      
      <nav class="nav-section">
        <a class="navlink" data-target="overview" href="#overview"><i data-lucide="home"></i>Framework Overview</a>
      </nav>
      
      <div class="nav-section">
        <div class="nav-label">The Five Phases</div>
        <div class="section">
          <button type="button" aria-expanded="false" onclick="toggleSection(this)">
            <i data-lucide="target"></i>Phase 1: Frame Decision
            <i class="chev" data-lucide="chevron-right" style="margin-left:auto;"></i>
          </button>
          <nav class="subnav">
            <a data-target="phase1" href="#phase1">SMART Questions</a>
          </nav>
        </div>
        <div class="section">
          <button type="button" aria-expanded="false" onclick="toggleSection(this)">
            <i data-lucide="database"></i>Phase 2: Extract Data
            <i class="chev" data-lucide="chevron-right" style="margin-left:auto;"></i>
          </button>
          <nav class="subnav">
            <a data-target="phase2" href="#phase2">Best Practices</a>
          </nav>
        </div>
        <div class="section">
          <button type="button" aria-expanded="false" onclick="toggleSection(this)">
            <i data-lucide="line-chart"></i>Phase 3: Interpret
            <i class="chev" data-lucide="chevron-right" style="margin-left:auto;"></i>
          </button>
          <nav class="subnav">
            <a data-target="phase3" href="#phase3">Rigorous Analysis</a>
          </nav>
        </div>
        <div class="section">
          <button type="button" aria-expanded="false" onclick="toggleSection(this)">
            <i data-lucide="shield-check"></i>Phase 4: Bias Detection
            <i class="chev" data-lucide="chevron-right" style="margin-left:auto;"></i>
          </button>
          <nav class="subnav">
            <a data-target="phase4" href="#phase4">Detection Methods</a>
          </nav>
        </div>
        <div class="section">
          <button type="button" aria-expanded="false" onclick="toggleSection(this)">
            <i data-lucide="file-check-2"></i>Phase 5: Decisions
            <i class="chev" data-lucide="chevron-right" style="margin-left:auto;"></i>
          </button>
          <nav class="subnav">
            <a data-target="phase5" href="#phase5">Documentation</a>
          </nav>
        </div>
      </div>
      
      <div class="nav-section">
        <div class="nav-label">Lean Six Sigma Tools</div>
        <a class="navlink" data-target="ctqBuilder" href="#ctqBuilder"><i data-lucide="git-branch"></i>CTQ Tree Builder</a>
        <a class="navlink" data-target="fiveWhys" href="#fiveWhys"><i data-lucide="help-circle"></i>5 Whys Analysis</a>
      </div>

      <div class="nav-section">
        <div class="nav-label">Interactive Tools</div>
        <a class="navlink" data-target="biasChecker" href="#biasChecker"><i data-lucide="check-circle"></i>Bias Self-Check</a>
        <a class="navlink" data-target="sampleCalc" href="#sampleCalc"><i data-lucide="calculator"></i>Sample Size Calculator</a>
        <a class="navlink" data-target="decisionTemplate" href="#decisionTemplate"><i data-lucide="file-text"></i>Decision Template</a>
        <a class="navlink" data-target="challengeMode" href="#challengeMode"><i data-lucide="swords"></i>Challenge My Analysis</a>
      </div>
      
      <div class="nav-section">
        <div class="nav-label">Role Guidelines</div>
        <a class="navlink" data-target="businessUsers" href="#businessUsers"><i data-lucide="briefcase"></i>Business Users</a>
        <a class="navlink" data-target="analysts" href="#analysts"><i data-lucide="flask-conical"></i>Analysts</a>
        <a class="navlink" data-target="dataPros" href="#dataPros"><i data-lucide="settings-2"></i>Data Professionals</a>
      </div>
      
      <div class="nav-section">
        <div class="nav-label">Quick Reference</div>
        <a class="navlink" data-target="sampleSize" href="#sampleSize"><i data-lucide="ruler"></i>Sample Size Guide</a>
        <a class="navlink" data-target="dosDonts" href="#dosDonts"><i data-lucide="list-checks"></i>Do's & Don'ts</a>
      </div>
      
      <div class="side-footer">
        <div class="side-cta">
          <button class="btn" onclick="expandAll()"><i data-lucide="chevrons-down"></i>Expand</button>
          <button class="btn ghost" onclick="collapseAll()"><i data-lucide="chevrons-right"></i>Collapse</button>
        </div>
        <p class="note" style="padding:0; margin:0;">
          <span class="kbd">⌘K</span> command · <span class="kbd">/</span> search · <span class="kbd">t</span> theme
        </p>
      </div>
    </aside>
    
    <section class="center">
      <div class="top" id="topbar">
        <div class="container">
          <div class="topbar">
            <div class="crumbs" id="crumbs"><i data-lucide="bookmark"></i><span>Overview</span></div>
            <div style="display:flex; gap:6px;">
              <button class="btn ghost" onclick="copyLink()" title="Copy link"><i data-lucide="link-2"></i></button>
              <button class="btn ghost" onclick="toggleTheme()" title="Toggle theme"><i id="themeIcon" data-lucide="sun"></i></button>
              <button class="btn ghost" onclick="window.print()" title="Print"><i data-lucide="printer"></i></button>
              <button class="btn" onclick="openCmd()" title="Command (⌘K)"><i data-lucide="command"></i></button>
            </div>
          </div>
          <div class="hero">
            <div class="heroCard" id="heroCard">
              <div class="heroIcon"><i id="heroIcon" data-lucide="home"></i></div>
              <div>
                <h2 id="heroTitle">Framework Overview</h2>
                <p id="heroTag" class="muted">Start with questions, not data. Let evidence drive decisions.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="container main">
        <div id="content" class="content" tabindex="-1"></div>
      </div>
    </section>
  </div>
  
  <div class="fab">
    <button class="btn" onclick="scrollTo({top:0, behavior:'smooth'})" title="Back to top"><i data-lucide="arrow-up"></i></button>
  </div>
  
  <div class="cmdk" id="cmdk" role="dialog" aria-modal="true" aria-label="Command palette">
    <div class="cmd" role="document">
      <div class="cmdHead"><i data-lucide="search"></i><input id="cmdInput" placeholder="Jump to any section…" /></div>
      <div class="cmdList" id="cmdList"></div>
    </div>
  </div>
  
  <script>
    // ===============================
    // CORE UTILITIES
    // ===============================
    function renderIcons(){ window.lucide && window.lucide.createIcons(); }
    function html(markup){ const div=document.createElement('div'); div.innerHTML=markup.trim(); return div; }

    // ===============================
    // THEME
    // ===============================
    const themeKey='dbp-theme';
    function applyTheme(t){ 
      document.documentElement.setAttribute('data-theme', t); 
      const icon = (t==='light'?'moon':'sun'); 
      document.getElementById('themeIcon').setAttribute('data-lucide', icon); 
      renderIcons(); 
    }
    function toggleTheme(){ 
      const cur=document.documentElement.getAttribute('data-theme')||'dark'; 
      const nxt=cur==='light'?'dark':'light'; 
      localStorage.setItem(themeKey,nxt); 
      applyTheme(nxt); 
    }

    // ===============================
    // NAVIGATION
    // ===============================
    function toggleMenu(){ document.getElementById('leftNav').classList.toggle('open'); }
    
    function toggleSection(btn){ 
      const nav=btn.nextElementSibling; 
      const chev=btn.querySelector('.chev'); 
      const exp=btn.getAttribute('aria-expanded')==='true'; 
      btn.setAttribute('aria-expanded',!exp); 
      nav.style.display=exp?'none':'block'; 
      if(chev) chev.setAttribute('data-lucide', exp?'chevron-right':'chevron-down'); 
      renderIcons(); 
    }
    function expandAll(){ document.querySelectorAll('.section > button').forEach(b=>{ if(b.getAttribute('aria-expanded')==='false') toggleSection(b); }); }
    function collapseAll(){ document.querySelectorAll('.section > button').forEach(b=>{ if(b.getAttribute('aria-expanded')==='true') toggleSection(b); }); }

    function onScroll(){ 
      const doc=document.scrollingElement; 
      const pct=(doc.scrollTop)/(doc.scrollHeight-doc.clientHeight)*100; 
      document.getElementById('progress').style.width=pct+'%'; 
    }
    document.addEventListener('scroll', onScroll, {passive:true});

    // ===============================
    // COMMAND PALETTE
    // ===============================
    const cmdk=document.getElementById('cmdk'); 
    const cmdInput=document.getElementById('cmdInput'); 
    const cmdList=document.getElementById('cmdList');
    
    function openCmd(){ cmdk.classList.add('open'); cmdInput.value=''; renderCmd(''); cmdInput.focus(); }
    function closeCmd(){ cmdk.classList.remove('open'); }
    cmdk.addEventListener('click',(e)=>{ if(e.target===cmdk) closeCmd(); });
    cmdInput.addEventListener('input',()=> renderCmd(cmdInput.value));

    document.addEventListener('keydown',(e)=>{
      if((e.key.toLowerCase()==='k'&&(e.metaKey||e.ctrlKey))){ e.preventDefault(); openCmd(); }
      if(e.key==='Escape'&&cmdk.classList.contains('open')) closeCmd();
      if(e.key.toLowerCase()==='t'&&!cmdk.classList.contains('open')&&document.activeElement.tagName!=='INPUT'&&document.activeElement.tagName!=='TEXTAREA') toggleTheme();
      if(e.key==='/'){ const a=document.activeElement; if(!a||(a.tagName!=='INPUT'&&a.tagName!=='TEXTAREA')){ e.preventDefault(); document.getElementById('q').focus(); } }
    });

    function renderCmd(q){ 
      const items=navItems().map(it=>({key:it.getAttribute('data-target'), label: it.textContent.trim()})); 
      const t=(q||'').toLowerCase(); 
      const filtered=items.filter(x=>!t||x.label.toLowerCase().includes(t)); 
      cmdList.innerHTML=''; 
      filtered.forEach(x=>{ 
        const row=document.createElement('div'); 
        row.className='cmdItem'; 
        row.tabIndex=0; 
        row.innerHTML=`<i data-lucide="hash"></i><div>${x.label}</div>`; 
        row.addEventListener('click',()=>{ navigateTo(x.key); closeCmd(); }); 
        row.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ navigateTo(x.key); closeCmd(); } }); 
        cmdList.appendChild(row); 
      }); 
      renderIcons(); 
    }

    // ===============================
    // SEARCH
    // ===============================
    function onSearch(text){ 
      const t=(text||'').toLowerCase(); 
      document.querySelectorAll('.navlink, .subnav a').forEach(a=>{ 
        a.style.display=!t||a.textContent.toLowerCase().includes(t)?'':'none'; 
      }); 
      highlight(t); 
    }
    
    function highlight(term){ 
      const root=document.getElementById('content'); 
      root.querySelectorAll('mark').forEach(m=>{ const p=m.parentNode; p.replaceChild(document.createTextNode(m.textContent), m); p.normalize(); }); 
      if(!term) return; 
      const w=document.createTreeWalker(root, NodeFilter.SHOW_TEXT); 
      const nodes=[]; 
      while(w.nextNode()) nodes.push(w.currentNode); 
      const re=new RegExp(term.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'gi'); 
      nodes.forEach(n=>{ 
        const text=n.nodeValue; 
        if(!text.trim()) return; 
        const frag=document.createDocumentFragment(); 
        let last=0, m; 
        while((m=re.exec(text))){ 
          if(m.index>last) frag.appendChild(document.createTextNode(text.slice(last,m.index))); 
          const mark=document.createElement('mark'); 
          mark.textContent=m[0]; 
          frag.appendChild(mark); 
          last=m.index+m[0].length; 
        } 
        if(last<text.length) frag.appendChild(document.createTextNode(text.slice(last))); 
        if(frag.childNodes.length) n.parentNode.replaceChild(frag,n); 
      }); 
    }

    // ===============================
    // INTERACTIVE TOOLS - BIAS CHECKER
    // ===============================
    const biasChecks = [
      {
        id: 'cherry',
        title: 'Cherry-Picking Check',
        desc: 'Did I examine ALL relevant time periods and metrics, not just favorable ones?',
        why: 'Cherry-picking data that supports a predetermined conclusion leads to flawed decisions. Always examine the full picture, including data that contradicts your initial hypothesis.'
      },
      {
        id: 'confirm',
        title: 'Confirmation Bias Check',
        desc: 'Did I define my hypothesis BEFORE seeing data and actively seek disconfirming evidence?',
        why: 'We naturally seek information that confirms what we already believe. Counter this by deliberately looking for evidence that proves you wrong before concluding you\'re right.'
      },
      {
        id: 'sample',
        title: 'Sample Size Check',
        desc: 'Is my sample large enough for statistically valid conclusions?',
        why: 'Small samples can show dramatic patterns that disappear with more data. Ensure your sample size provides sufficient statistical power for the conclusions you\'re drawing.'
      },
      {
        id: 'recency',
        title: 'Recency Bias Check',
        desc: 'Am I overweighting recent events while undervaluing historical patterns?',
        why: 'Recent events feel more important and memorable, but they may be outliers. Historical patterns often provide better predictive value than recent anomalies.'
      },
      {
        id: 'anchor',
        title: 'Anchoring Bias Check',
        desc: 'Am I overly attached to historical baselines that may no longer apply?',
        why: 'Past performance anchors our expectations, but markets, technology, and circumstances change. Validate that historical baselines still apply to current conditions.'
      },
      {
        id: 'season',
        title: 'Seasonality Check',
        desc: 'Have I compared appropriate periods (YoY) and accounted for seasonal patterns?',
        why: 'Comparing December to November ignores seasonal effects. Year-over-year comparisons and seasonal adjustments reveal true underlying trends.'
      }
    ];

    // Bias checker state management with notes support
    let biasAutoSaveTimer = null;
    let biasExpandedItems = new Set();

    function getBiasState() {
      try {
        const state = JSON.parse(localStorage.getItem('dbp-bias-state') || '{}');
        // Ensure notes object exists
        if (!state.notes) state.notes = {};
        return state;
      } catch { return { notes: {} }; }
    }
    function setBiasState(state) {
      localStorage.setItem('dbp-bias-state', JSON.stringify(state));
    }

    function formatBiasLastSaved(timestamp) {
      if (!timestamp) return '';
      const date = new Date(timestamp);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);

      if (diffMins < 1) return 'just now';
      if (diffMins < 60) return `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
      if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
      return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }

    function updateBiasLastSavedDisplay() {
      const state = getBiasState();
      const el = document.getElementById('bias-last-saved');
      if (el && state.lastSaved) {
        el.textContent = `Auto-saved ${formatBiasLastSaved(state.lastSaved)}`;
        el.classList.add('visible');
      }
    }

    function saveBiasNotes(id) {
      clearTimeout(biasAutoSaveTimer);
      biasAutoSaveTimer = setTimeout(() => {
        const state = getBiasState();
        const textarea = document.getElementById(`bias-notes-${id}`);
        if (textarea) {
          if (!state.notes) state.notes = {};
          state.notes[id] = textarea.value;
          state.lastSaved = Date.now();
          setBiasState(state);
          updateBiasLastSavedDisplay();
        }
      }, 600);
    }

    function toggleBiasExpand(id, event) {
      event.stopPropagation();
      if (biasExpandedItems.has(id)) {
        biasExpandedItems.delete(id);
      } else {
        biasExpandedItems.add(id);
      }
      renderView('biasChecker');
    }

    function renderBiasChecker() {
      const state = getBiasState();
      const checkedItems = biasChecks.filter(c => state[c.id]);
      const checked = checkedItems.length;
      const total = biasChecks.length;
      const pct = Math.round((checked / total) * 100);
      const circumference = 2 * Math.PI * 52;
      const offset = circumference - (pct / 100) * circumference;
      const isComplete = pct === 100;

      let status, statusClass;
      if (isComplete) { status = 'Ready to Proceed'; statusClass = 'ok'; }
      else if (pct >= 50) { status = 'Review Remaining'; statusClass = 'brand'; }
      else { status = 'Needs Attention'; statusClass = 'danger'; }

      const lastSavedText = state.lastSaved ? formatBiasLastSaved(state.lastSaved) : '';

      return `
        <div class="card tool">
          <h3>Interactive Bias Self-Check</h3>
          <p>Complete each checkpoint before finalizing any analysis. Click any item to add notes.</p>

          <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 24px; margin-top: 20px;">
            <div style="text-align: center;">
              <div class="score-ring ${isComplete ? 'complete' : ''}">
                <svg viewBox="0 0 120 120">
                  <circle class="bg" cx="60" cy="60" r="52"/>
                  <circle class="fill" cx="60" cy="60" r="52"
                    stroke-dasharray="${circumference}"
                    stroke-dashoffset="${offset}"
                    style="stroke: ${isComplete ? 'var(--accent)' : pct >= 50 ? 'var(--brand)' : 'var(--danger)'}"/>
                </svg>
                <div class="score-text">
                  <span>${checked}/${total}</span>
                  <span class="score-label">Checks</span>
                </div>
              </div>
              <div class="traffic" style="justify-content: center; margin-bottom: 8px;">
                <div class="traffic-light red ${pct < 50 ? 'active' : ''}"></div>
                <div class="traffic-light yellow ${pct >= 50 && pct < 100 ? 'active' : ''}"></div>
                <div class="traffic-light green ${isComplete ? 'active' : ''}"></div>
              </div>
              ${isComplete
                ? `<div class="completion-badge"><i data-lucide="shield-check"></i>All Clear</div>`
                : `<strong class="${statusClass}">${status}</strong>`
              }
              <div id="bias-last-saved" class="bias-last-saved ${lastSavedText ? 'visible' : ''}">
                <i data-lucide="save"></i>${lastSavedText ? `Auto-saved ${lastSavedText}` : ''}
              </div>
            </div>

            <ul class="check-list">
              ${biasChecks.map(c => {
                const isExpanded = biasExpandedItems.has(c.id);
                const noteValue = state.notes?.[c.id] || '';
                const hasNote = noteValue.trim().length > 0;
                return `
                <li class="check-item check-item-expanded ${state[c.id] ? 'checked' : ''} ${isExpanded ? 'expanded' : ''}">
                  <div class="check-item-header" onclick="toggleBiasCheck('${c.id}')">
                    <input type="checkbox" ${state[c.id] ? 'checked' : ''} onchange="toggleBiasCheck('${c.id}')" onclick="event.stopPropagation()">
                    <label onclick="event.stopPropagation(); toggleBiasCheck('${c.id}')">
                      <span class="check-title">${c.title}</span>
                      <span class="check-desc">${c.desc}</span>
                      <span class="check-why-toggle" onclick="toggleBiasExpand('${c.id}', event)">
                        <i data-lucide="chevron-down"></i>
                        ${isExpanded ? 'Hide details' : 'Why it matters'}${hasNote ? ' • Has notes' : ''}
                      </span>
                    </label>
                  </div>
                  <div class="check-item-body">
                    <div class="check-why-content">
                      <i data-lucide="lightbulb"></i>${c.why}
                    </div>
                    <label class="check-notes-label">Your notes (optional)</label>
                    <textarea
                      class="check-notes-input"
                      id="bias-notes-${c.id}"
                      placeholder="Document how you verified this check..."
                      oninput="saveBiasNotes('${c.id}')"
                      onclick="event.stopPropagation()"
                    >${noteValue}</textarea>
                  </div>
                </li>
              `}).join('')}
            </ul>
          </div>

          <div class="export-bar">
            <button class="btn" onclick="resetBiasCheck()"><i data-lucide="rotate-ccw"></i>Reset All</button>
            <button class="btn primary" onclick="exportBiasCheck()"><i data-lucide="download"></i>Export Summary</button>
          </div>
        </div>

        <div class="callout ${isComplete ? 'success' : pct >= 50 ? 'info' : ''}">
          <strong>${isComplete ? '✓ All checks complete!' : pct >= 50 ? 'Making progress...' : '⚠️ Important:'}</strong>
          ${isComplete
            ? 'Your analysis has passed all bias checks. Document your findings with confidence.'
            : pct >= 50
              ? `${total - checked} check${total - checked > 1 ? 's' : ''} remaining. Review carefully before proceeding.`
              : 'If you cannot confidently check all items, consult an analyst before proceeding with your analysis.'}
        </div>
      `;
    }
    
    function toggleBiasCheck(id) {
      const state = getBiasState();
      state[id] = !state[id];
      state.lastSaved = Date.now();
      setBiasState(state);
      renderView('biasChecker');
    }

    function resetBiasCheck() {
      if (confirm('Reset all bias checks and notes? This cannot be undone.')) {
        setBiasState({ notes: {} });
        biasExpandedItems.clear();
        renderView('biasChecker');
      }
    }

    function exportBiasCheck() {
      const state = getBiasState();
      const date = new Date().toLocaleDateString();
      const time = new Date().toLocaleTimeString();
      let text = `BIAS SELF-CHECK SUMMARY\n`;
      text += `Generated: ${date} at ${time}\n`;
      text += `${'='.repeat(50)}\n\n`;

      biasChecks.forEach(c => {
        const isChecked = state[c.id];
        const note = state.notes?.[c.id]?.trim();
        text += `[${isChecked ? '✓' : ' '}] ${c.title}\n`;
        text += `    ${c.desc}\n`;
        if (note) {
          text += `\n    NOTES:\n`;
          // Indent each line of the note
          note.split('\n').forEach(line => {
            text += `    ${line}\n`;
          });
        }
        text += `\n`;
      });

      const checked = biasChecks.filter(c => state[c.id]).length;
      const hasNotes = biasChecks.some(c => state.notes?.[c.id]?.trim());
      text += `${'='.repeat(50)}\n`;
      text += `RESULT: ${checked}/${biasChecks.length} checks passed\n`;
      text += checked === biasChecks.length ? 'STATUS: Ready to proceed\n' : 'STATUS: Review required\n';
      if (hasNotes) {
        text += `\nThis summary includes analyst notes for documentation.\n`;
      }

      downloadText(text, 'bias-check-summary.txt');
    }

    // ===============================
    // INTERACTIVE TOOLS - SAMPLE SIZE CALCULATOR
    // ===============================
    function renderSampleCalc() {
      return `
        <div class="callout"><strong>Why it matters:</strong> Small samples produce wide confidence intervals that can't distinguish real effects from noise. Know your precision before drawing conclusions.</div>

        <div class="card tool">
          <h3 style="display: flex; align-items: center; gap: 10px;"><i data-lucide="calculator" style="width:20px; height:20px; color:var(--brand);"></i> Sample Size & Confidence Calculator</h3>
          <p class="muted">Input your analysis parameters to calculate statistical confidence. Uses the Wilson score interval for accurate proportion estimates.</p>

          <div class="form-row" style="margin-top: 20px;">
            <div class="form-group">
              <label class="form-label form-label-icon"><i data-lucide="hash"></i> Sample Size (n)</label>
              <input type="number" class="form-input" id="calc-n" placeholder="e.g., 500" value="500" oninput="calculateCI()">
              <p class="form-hint">Number of observations in your sample</p>
            </div>
            <div class="form-group">
              <label class="form-label form-label-icon"><i data-lucide="percent"></i> Observed Rate (%)</label>
              <input type="number" class="form-input" id="calc-rate" placeholder="e.g., 95" value="95" min="0" max="100" step="0.1" oninput="calculateCI()">
              <p class="form-hint">Your measured percentage (0-100)</p>
            </div>
            <div class="form-group">
              <label class="form-label form-label-icon"><i data-lucide="shield-check"></i> Confidence Level</label>
              <select class="form-select" id="calc-conf" onchange="calculateCI()">
                <option value="1.645">90%</option>
                <option value="1.96" selected>95%</option>
                <option value="2.576">99%</option>
              </select>
              <p class="form-hint">Statistical confidence level</p>
            </div>
          </div>

          <div id="calc-results" style="margin-top: 20px;"></div>
        </div>

        <div class="card">
          <h3 style="display: flex; align-items: center; gap: 10px;"><i data-lucide="list-checks" style="width:18px; height:18px; color:var(--brand-2);"></i> Sample Size Minimums by Context</h3>
          <table class="threshold-table" style="margin-top: 12px;">
            <thead>
              <tr><th>Analysis Type</th><th>Minimum Sample</th><th>Notes</th></tr>
            </thead>
            <tbody>
              <tr><td><strong>Claims processing metrics</strong></td><td><span class="threshold-normal">100+ claims</span></td><td>Per specialist, per period</td></tr>
              <tr><td><strong>Client performance comparison</strong></td><td><span class="threshold-normal">200+ claims</span> or 3+ months</td><td>Smaller clients need longer timeframes</td></tr>
              <tr><td><strong>A/B testing</strong></td><td><span class="threshold-warning">500+ per variant</span></td><td>More for small effect sizes</td></tr>
              <tr><td><strong>Accuracy rates (95%+ baseline)</strong></td><td><span class="threshold-warning">300+ claims</span></td><td>High baselines need larger n</td></tr>
              <tr><td><strong>Return-to-work metrics</strong></td><td><span class="threshold-normal">50+ episodes</span></td><td>Full episode completion required</td></tr>
            </tbody>
          </table>
        </div>

        <div class="callout info">
          <strong>Rule of thumb:</strong> If your confidence interval is wider than the difference you're trying to detect, your sample is too small to draw conclusions.
        </div>
      `;
    }
    
    function calculateCI() {
      const n = parseInt(document.getElementById('calc-n').value) || 0;
      const rate = parseFloat(document.getElementById('calc-rate').value) / 100 || 0;
      const z = parseFloat(document.getElementById('calc-conf').value) || 1.96;
      const confLabel = document.getElementById('calc-conf').options[document.getElementById('calc-conf').selectedIndex].text;

      if (n <= 0 || rate < 0 || rate > 1) {
        document.getElementById('calc-results').innerHTML = `
          <div class="callout danger">Please enter valid values: sample size > 0 and rate between 0-100%.</div>
        `;
        return;
      }

      // Wilson score interval (more accurate for proportions)
      const p = rate;
      const q = 1 - p;
      const denominator = 1 + (z * z) / n;
      const center = (p + (z * z) / (2 * n)) / denominator;
      const margin = (z * Math.sqrt((p * q) / n + (z * z) / (4 * n * n))) / denominator;

      const lower = Math.max(0, (center - margin) * 100);
      const upper = Math.min(100, (center + margin) * 100);
      const observed = rate * 100;
      const width = upper - lower;

      // Calculate bar positions (scale to 0-100 range, but show meaningful range)
      const rangeMin = Math.max(0, lower - 10);
      const rangeMax = Math.min(100, upper + 10);
      const scale = 100 / (rangeMax - rangeMin);
      const barLeft = (lower - rangeMin) * scale;
      const barWidth = (upper - lower) * scale;
      const markerPos = (observed - rangeMin) * scale;

      // Assessment
      let assessment, assessClass, assessIcon;
      if (width <= 3) {
        assessment = 'Excellent precision';
        assessClass = 'excellent';
        assessIcon = 'check-circle';
      } else if (width <= 5) {
        assessment = 'Good precision';
        assessClass = 'good';
        assessIcon = 'check-circle';
      } else if (width <= 10) {
        assessment = 'Moderate precision — consider larger sample';
        assessClass = 'moderate';
        assessIcon = 'alert-circle';
      } else {
        assessment = 'Low precision — increase sample size';
        assessClass = 'low';
        assessIcon = 'alert-triangle';
      }

      document.getElementById('calc-results').innerHTML = `
        <div class="card result">
          <h4 style="margin-top:0; display: flex; align-items: center; gap: 8px;">
            <i data-lucide="bar-chart-3" style="width:18px; height:18px; color:var(--accent);"></i>
            Results
          </h4>

          <div class="ci-visual">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <span class="muted" style="font-size: 12px;">Confidence Interval (${confLabel})</span>
              <span style="font-size: 13px;"><strong>${lower.toFixed(1)}%</strong> — <strong>${upper.toFixed(1)}%</strong></span>
            </div>
            <div class="ci-bar-container">
              <div class="ci-bar-range" style="left: ${barLeft}%; width: ${barWidth}%;"></div>
              <div class="ci-bar-marker" style="left: ${markerPos}%;"></div>
            </div>
            <div class="ci-bar-labels">
              <span>${rangeMin.toFixed(0)}%</span>
              <span>Observed: ${observed.toFixed(1)}%</span>
              <span>${rangeMax.toFixed(0)}%</span>
            </div>
          </div>

          <div class="ci-stats">
            <div class="ci-stat">
              <div class="ci-stat-value lower">${lower.toFixed(1)}%</div>
              <div class="ci-stat-label">Lower Bound</div>
            </div>
            <div class="ci-stat">
              <div class="ci-stat-value observed">${observed.toFixed(1)}%</div>
              <div class="ci-stat-label">Observed Rate</div>
            </div>
            <div class="ci-stat">
              <div class="ci-stat-value upper">${upper.toFixed(1)}%</div>
              <div class="ci-stat-label">Upper Bound</div>
            </div>
            <div class="ci-stat">
              <div class="ci-stat-value">±${(width/2).toFixed(1)}%</div>
              <div class="ci-stat-label">Margin of Error</div>
            </div>
          </div>

          <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border);">
            <p style="margin-bottom: 12px;"><strong>Interpretation:</strong> With <strong>${n.toLocaleString()}</strong> observations at ${confLabel} confidence, the true rate is between <strong>${lower.toFixed(1)}%</strong> and <strong>${upper.toFixed(1)}%</strong>.</p>
            <div class="assessment-badge ${assessClass}">
              <i data-lucide="${assessIcon}"></i>
              ${assessment}
            </div>
          </div>
        </div>
      `;
      renderIcons();
    }

    // ===============================
    // INTERACTIVE TOOLS - DECISION TEMPLATE
    // ===============================
    function renderDecisionTemplate() {
      return `
        <div class="card tool">
          <h3>Decision Documentation Generator</h3>
          <p>Complete this template before any significant operational decision. Export as a professional document when done.</p>
          
          <div style="margin-top: 20px;">
            <h4 style="margin-top:0;">Decision Summary</h4>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Decision Title</label>
                <input type="text" class="form-input" id="dec-title" placeholder="e.g., Add 2 FTE specialists to STD team">
              </div>
              <div class="form-group">
                <label class="form-label">Decision Maker</label>
                <input type="text" class="form-input" id="dec-maker" placeholder="Name and role">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Decision Date</label>
                <input type="date" class="form-input" id="dec-date" value="${new Date().toISOString().split('T')[0]}">
              </div>
              <div class="form-group">
                <label class="form-label">Implementation Timeline</label>
                <input type="text" class="form-input" id="dec-timeline" placeholder="e.g., December 1, 2025">
              </div>
            </div>
            
            <h4>Analysis Foundation</h4>
            <div class="form-group">
              <label class="form-label">Primary Finding</label>
              <textarea class="form-textarea" id="dec-finding" placeholder="What is the main insight driving this decision?"></textarea>
            </div>
            <div class="form-group">
              <label class="form-label">Supporting Evidence</label>
              <textarea class="form-textarea" id="dec-evidence" placeholder="List key metrics and data points (e.g., Claims per specialist: 195 → 212, TAT: 23.2 → 26.8 days)"></textarea>
            </div>
            <div class="form-group">
              <label class="form-label">Confidence Level</label>
              <select class="form-select" id="dec-confidence">
                <option value="High">High - Strong evidence, large sample, multiple confirming sources</option>
                <option value="Medium" selected>Medium - Reasonable evidence with some uncertainty</option>
                <option value="Low">Low - Limited data, small samples, or conflicting signals</option>
              </select>
            </div>
            
            <h4>Decision Rationale</h4>
            <div class="form-group">
              <label class="form-label">Why this decision? Why now?</label>
              <textarea class="form-textarea" id="dec-rationale" placeholder="Explain the reasoning behind this specific choice and timing"></textarea>
            </div>
            <div class="form-group">
              <label class="form-label">Alternatives Considered</label>
              <textarea class="form-textarea" id="dec-alternatives" placeholder="What other options were evaluated and why were they rejected?"></textarea>
            </div>
            
            <h4>Risks & Monitoring</h4>
            <div class="form-group">
              <label class="form-label">Key Risks</label>
              <textarea class="form-textarea" id="dec-risks" placeholder="What could go wrong? What assumptions might be incorrect?"></textarea>
            </div>
            <div class="form-group">
              <label class="form-label">Success Metrics & Monitoring Plan</label>
              <textarea class="form-textarea" id="dec-monitoring" placeholder="How will you measure success? What leading indicators will you track?"></textarea>
            </div>
            <div class="form-group">
              <label class="form-label">Expected Impact</label>
              <textarea class="form-textarea" id="dec-impact" placeholder="What outcomes do you expect? By when? (e.g., TAT back to 23-24 days by Feb 2026)"></textarea>
            </div>
          </div>
          
          <div class="export-bar">
            <button class="btn" onclick="clearDecisionForm()"><i data-lucide="trash-2"></i>Clear Form</button>
            <button class="btn" onclick="exportDecisionMarkdown()"><i data-lucide="file-text"></i>Export Markdown</button>
            <button class="btn primary" onclick="exportDecisionHTML()"><i data-lucide="file-down"></i>Export Document</button>
          </div>
        </div>
      `;
    }
    
    function getDecisionData() {
      return {
        title: document.getElementById('dec-title')?.value || '',
        maker: document.getElementById('dec-maker')?.value || '',
        date: document.getElementById('dec-date')?.value || '',
        timeline: document.getElementById('dec-timeline')?.value || '',
        finding: document.getElementById('dec-finding')?.value || '',
        evidence: document.getElementById('dec-evidence')?.value || '',
        confidence: document.getElementById('dec-confidence')?.value || 'Medium',
        rationale: document.getElementById('dec-rationale')?.value || '',
        alternatives: document.getElementById('dec-alternatives')?.value || '',
        risks: document.getElementById('dec-risks')?.value || '',
        monitoring: document.getElementById('dec-monitoring')?.value || '',
        impact: document.getElementById('dec-impact')?.value || ''
      };
    }
    
    function clearDecisionForm() {
      if (confirm('Clear all form fields? This cannot be undone.')) {
        document.querySelectorAll('#content input, #content textarea, #content select').forEach(el => {
          if (el.type === 'date') el.value = new Date().toISOString().split('T')[0];
          else if (el.tagName === 'SELECT') el.selectedIndex = 1;
          else el.value = '';
        });
      }
    }
    
    function exportDecisionMarkdown() {
      const d = getDecisionData();
      let md = `# Decision Document: ${d.title || 'Untitled'}\n\n`;
      md += `**Decision Maker:** ${d.maker || 'N/A'}  \n`;
      md += `**Date:** ${d.date || 'N/A'}  \n`;
      md += `**Implementation:** ${d.timeline || 'N/A'}  \n`;
      md += `**Confidence Level:** ${d.confidence}\n\n`;
      md += `---\n\n`;
      md += `## Primary Finding\n\n${d.finding || 'Not specified'}\n\n`;
      md += `## Supporting Evidence\n\n${d.evidence || 'Not specified'}\n\n`;
      md += `## Decision Rationale\n\n${d.rationale || 'Not specified'}\n\n`;
      md += `## Alternatives Considered\n\n${d.alternatives || 'Not specified'}\n\n`;
      md += `## Risks\n\n${d.risks || 'Not specified'}\n\n`;
      md += `## Monitoring Plan\n\n${d.monitoring || 'Not specified'}\n\n`;
      md += `## Expected Impact\n\n${d.impact || 'Not specified'}\n\n`;
      md += `---\n\n*Generated by Data Best Practices Framework on ${new Date().toLocaleDateString()}*\n`;
      
      downloadText(md, `decision-${d.title?.replace(/\s+/g,'-').toLowerCase() || 'document'}.md`);
    }
    
    function exportDecisionHTML() {
      const d = getDecisionData();
      const html = `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Decision Document - ${d.title || 'Untitled'}</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; line-height: 1.6; color: #1f2937; }
    h1 { color: #111827; border-bottom: 2px solid #3b82f6; padding-bottom: 12px; }
    h2 { color: #374151; margin-top: 32px; font-size: 18px; }
    .meta { background: #f3f4f6; padding: 16px; border-radius: 8px; margin: 20px 0; }
    .meta p { margin: 4px 0; }
    .confidence { display: inline-block; padding: 4px 12px; border-radius: 4px; font-weight: 600; }
    .confidence.High { background: #d1fae5; color: #065f46; }
    .confidence.Medium { background: #dbeafe; color: #1e40af; }
    .confidence.Low { background: #fee2e2; color: #991b1b; }
    .section { margin: 24px 0; padding: 16px; background: #fafafa; border-left: 4px solid #e5e7eb; border-radius: 0 8px 8px 0; }
    .section.risks { border-left-color: #f59e0b; background: #fffbeb; }
    .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #e5e7eb; color: #6b7280; font-size: 14px; }
    @media print { body { margin: 0; } }
  </style>
</head>
<body>
  <h1>Decision Document</h1>
  <h2 style="margin-top:0; border:none; color:#3b82f6;">${d.title || 'Untitled Decision'}</h2>
  
  <div class="meta">
    <p><strong>Decision Maker:</strong> ${d.maker || 'N/A'}</p>
    <p><strong>Date:</strong> ${d.date || 'N/A'}</p>
    <p><strong>Implementation Timeline:</strong> ${d.timeline || 'N/A'}</p>
    <p><strong>Confidence Level:</strong> <span class="confidence ${d.confidence}">${d.confidence}</span></p>
  </div>
  
  <h2>Primary Finding</h2>
  <div class="section">${d.finding?.replace(/\n/g, '<br>') || '<em>Not specified</em>'}</div>
  
  <h2>Supporting Evidence</h2>
  <div class="section">${d.evidence?.replace(/\n/g, '<br>') || '<em>Not specified</em>'}</div>
  
  <h2>Decision Rationale</h2>
  <div class="section">${d.rationale?.replace(/\n/g, '<br>') || '<em>Not specified</em>'}</div>
  
  <h2>Alternatives Considered</h2>
  <div class="section">${d.alternatives?.replace(/\n/g, '<br>') || '<em>Not specified</em>'}</div>
  
  <h2>Risks</h2>
  <div class="section risks">${d.risks?.replace(/\n/g, '<br>') || '<em>Not specified</em>'}</div>
  
  <h2>Monitoring Plan</h2>
  <div class="section">${d.monitoring?.replace(/\n/g, '<br>') || '<em>Not specified</em>'}</div>
  
  <h2>Expected Impact</h2>
  <div class="section">${d.impact?.replace(/\n/g, '<br>') || '<em>Not specified</em>'}</div>
  
  <div class="footer">
    Generated by Data Best Practices Framework on ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}
  </div>
</body>
</html>`;
      
      downloadText(html, `decision-${d.title?.replace(/\s+/g,'-').toLowerCase() || 'document'}.html`, 'text/html');
    }

    // ===============================
    // INTERACTIVE TOOLS - CHALLENGE MODE
    // ===============================
    // Challenge Mode state
    let challengeState = { responses: {}, intensity: 'thorough' };

    function renderChallengeMode() {
      return `
        <div class="callout"><strong>Why it matters:</strong> Research shows that actively seeking disconfirming evidence dramatically improves decision quality. Pre-mortems catch 30% more potential problems than post-hoc reviews.</div>

        <div class="card tool">
          <h3 style="display: flex; align-items: center; gap: 10px;"><i data-lucide="swords" style="width:20px; height:20px; color:var(--purple);"></i> Challenge My Analysis</h3>
          <p class="muted">Enter your analysis details below. This tool will parse your input and generate tailored devil's advocate questions.</p>

          <div style="margin-top: 20px;">
            <div class="form-group">
              <label class="form-label form-label-icon"><i data-lucide="message-square"></i> Your Conclusion</label>
              <textarea class="form-textarea" id="chal-conclusion" placeholder="e.g., We need to hire 2 additional specialists because TAT increased 17% from 23 to 27 days and is trending toward our 30-day SLA threshold"></textarea>
              <p class="form-hint">Be specific — include numbers, percentages, and action words for better tailored questions</p>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label form-label-icon"><i data-lucide="bar-chart-3"></i> Key Metric(s)</label>
                <input type="text" class="form-input" id="chal-metrics" placeholder="e.g., TAT increased from 23 to 27 days (17%)">
              </div>
              <div class="form-group">
                <label class="form-label form-label-icon"><i data-lucide="calendar"></i> Time Period Analyzed</label>
                <input type="text" class="form-input" id="chal-period" placeholder="e.g., Q3 2025 vs Q3 2024">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label form-label-icon"><i data-lucide="hash"></i> Sample Size</label>
                <input type="text" class="form-input" id="chal-sample" placeholder="e.g., 4,200 claims">
              </div>
              <div class="form-group">
                <label class="form-label form-label-icon"><i data-lucide="folder"></i> Analysis Type</label>
                <select class="form-select" id="chal-type">
                  <option value="staffing">Staffing/Capacity Decision</option>
                  <option value="performance">Performance Assessment</option>
                  <option value="process">Process Change</option>
                  <option value="client">Client Communication</option>
                  <option value="forecast">Forecasting/Projection</option>
                </select>
              </div>
            </div>

            <h4 style="margin: 20px 0 12px; display: flex; align-items: center; gap: 8px;"><i data-lucide="gauge" style="width:16px; height:16px; color:var(--muted);"></i> Challenge Intensity</h4>
            <div class="intensity-selector">
              <div class="intensity-btn" data-intensity="quick" onclick="setIntensity('quick')">
                <div class="intensity-icon">⚡</div>
                <div class="intensity-label">Quick Check</div>
                <div class="intensity-desc">5 essential questions</div>
              </div>
              <div class="intensity-btn active" data-intensity="thorough" onclick="setIntensity('thorough')">
                <div class="intensity-icon">🔍</div>
                <div class="intensity-label">Thorough</div>
                <div class="intensity-desc">9 comprehensive questions</div>
              </div>
              <div class="intensity-btn" data-intensity="rigorous" onclick="setIntensity('rigorous')">
                <div class="intensity-icon">🎯</div>
                <div class="intensity-label">Rigorous</div>
                <div class="intensity-desc">12+ for high-stakes decisions</div>
              </div>
            </div>

            <button class="btn primary" style="width:100%; margin-top:8px;" onclick="generateChallenges()">
              <i data-lucide="zap"></i>Generate Tailored Challenges
            </button>
          </div>

          <div id="challenge-results" style="margin-top: 20px;"></div>
        </div>
      `;
    }

    function setIntensity(level) {
      challengeState.intensity = level;
      document.querySelectorAll('.intensity-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.intensity === level);
      });
    }

    function parseInputPatterns(conclusion, metrics, period, sample) {
      const patterns = [];
      const allText = (conclusion + ' ' + metrics + ' ' + period).toLowerCase();

      // Detect numbers and percentages
      const percentMatch = allText.match(/(\d+(?:\.\d+)?)\s*%/g);
      const numberMatch = allText.match(/\b(\d{1,3}(?:,\d{3})*(?:\.\d+)?)\b/g);

      if (percentMatch) patterns.push({ type: 'percentage', values: percentMatch, icon: 'percent' });
      if (numberMatch && numberMatch.length > 1) patterns.push({ type: 'comparison', icon: 'git-compare' });

      // Detect direction words
      if (/increas|up|grew|higher|rise|spike/i.test(allText)) patterns.push({ type: 'increase', icon: 'trending-up' });
      if (/decreas|down|drop|lower|fell|decline/i.test(allText)) patterns.push({ type: 'decrease', icon: 'trending-down' });

      // Detect action words
      if (/hire|add|expand|grow|scale/i.test(allText)) patterns.push({ type: 'expansion', icon: 'user-plus' });
      if (/cut|reduce|eliminate|remove|layoff/i.test(allText)) patterns.push({ type: 'reduction', icon: 'user-minus' });
      if (/implement|change|modify|update|switch/i.test(allText)) patterns.push({ type: 'change', icon: 'refresh-cw' });

      // Detect time patterns
      if (/q[1-4]|quarter/i.test(allText)) patterns.push({ type: 'quarterly', icon: 'calendar' });
      if (/year|annual|yoy|y-o-y/i.test(allText)) patterns.push({ type: 'yearly', icon: 'calendar-days' });
      if (/month|week|daily/i.test(allText)) patterns.push({ type: 'short-term', icon: 'clock' });

      // Detect threshold/SLA mentions
      if (/threshold|sla|target|goal|limit|benchmark/i.test(allText)) patterns.push({ type: 'threshold', icon: 'target' });

      // Parse sample size
      const sampleNum = sample ? parseInt(sample.replace(/,/g, '')) : 0;
      if (sampleNum > 0 && sampleNum < 100) patterns.push({ type: 'small-sample', icon: 'alert-triangle' });
      if (sampleNum >= 100 && sampleNum < 300) patterns.push({ type: 'moderate-sample', icon: 'info' });

      return patterns;
    }

    function generateChallenges() {
      const conclusion = document.getElementById('chal-conclusion').value;
      const metrics = document.getElementById('chal-metrics').value;
      const period = document.getElementById('chal-period').value;
      const sample = document.getElementById('chal-sample').value;
      const type = document.getElementById('chal-type').value;
      const intensity = challengeState.intensity;

      if (!conclusion) {
        document.getElementById('challenge-results').innerHTML = `
          <div class="callout danger">Please enter your conclusion to generate challenge questions.</div>
        `;
        return;
      }

      // Parse input for dynamic questions
      const patterns = parseInputPatterns(conclusion, metrics, period, sample);
      challengeState.responses = {};

      // Base challenges by type with icons and categories
      const challengeBank = {
        staffing: [
          { cat: 'Alternative Explanations', icon: 'git-branch', type: 'logic', q: 'Could the metric changes be explained by factors other than staffing (e.g., claim complexity, system issues, training gaps)?', priority: 1 },
          { cat: 'Seasonality', icon: 'calendar', type: 'context', q: 'Have you compared to the same period in prior years? Is this pattern consistent historically or an anomaly?', priority: 1 },
          { cat: 'Threshold Validity', icon: 'target', type: 'data', q: 'Is your performance threshold still appropriate? When was it last validated against industry benchmarks?', priority: 2 },
          { cat: 'Leading Indicators', icon: 'trending-up', type: 'logic', q: 'Are there leading indicators that predict whether this trend will continue, stabilize, or reverse?', priority: 2 },
          { cat: 'Cost-Benefit', icon: 'calculator', type: 'risk', q: 'What is the full cost of this decision vs. the cost of inaction? Have you quantified both including hidden costs?', priority: 1 },
          { cat: 'Reversibility', icon: 'undo', type: 'risk', q: 'If this decision proves wrong, how easily can it be reversed? What is the exit strategy?', priority: 2 },
          { cat: 'Capacity Alternatives', icon: 'settings', type: 'logic', q: 'Have you explored alternatives like process optimization, automation, or workload redistribution before adding headcount?', priority: 3 },
          { cat: 'Stakeholder Alignment', icon: 'users', type: 'context', q: 'Do all key stakeholders agree with this interpretation of the data? What objections have you heard?', priority: 3 }
        ],
        performance: [
          { cat: 'Cherry-Picking', icon: 'filter', type: 'bias', q: 'Are you showing all relevant metrics, or only the ones that support your narrative?', priority: 1 },
          { cat: 'Comparison Validity', icon: 'git-compare', type: 'data', q: 'Are the groups/periods you\'re comparing truly equivalent? What confounding factors exist?', priority: 1 },
          { cat: 'Statistical Significance', icon: 'percent', type: 'data', q: 'Is the observed difference statistically significant, or could it be random variation?', priority: 1, tool: 'sampleCalc' },
          { cat: 'Practical Significance', icon: 'target', type: 'logic', q: 'Even if statistically significant, is the difference large enough to matter operationally?', priority: 2 },
          { cat: 'Data Quality', icon: 'database', type: 'data', q: 'Are there known data quality issues that could affect these results? When was data last validated?', priority: 2 },
          { cat: 'Survivorship Bias', icon: 'eye-off', type: 'bias', q: 'Are you only analyzing successful/completed cases and missing important failure patterns?', priority: 2 },
          { cat: 'Regression to Mean', icon: 'activity', type: 'logic', q: 'Could this result be regression to the mean rather than a real change?', priority: 3 },
          { cat: 'Simpson\'s Paradox', icon: 'layers', type: 'data', q: 'Does this trend hold when you segment the data differently? Could aggregation be hiding opposite trends?', priority: 3 }
        ],
        process: [
          { cat: 'Root Cause', icon: 'search', type: 'logic', q: 'Are you addressing the root cause or just symptoms? Have you done proper root cause analysis (5 Whys)?', priority: 1, tool: 'fiveWhys' },
          { cat: 'Unintended Consequences', icon: 'alert-triangle', type: 'risk', q: 'What could go wrong? What unintended consequences might this process change create?', priority: 1 },
          { cat: 'Baseline Validity', icon: 'flag', type: 'data', q: 'Is your "before" measurement actually representative, or was it an anomaly?', priority: 1 },
          { cat: 'Implementation Risk', icon: 'construction', type: 'risk', q: 'What assumptions are you making about implementation that might not hold?', priority: 2 },
          { cat: 'Scale Effects', icon: 'maximize', type: 'logic', q: 'Will results from a pilot or limited sample hold at full scale?', priority: 2 },
          { cat: 'Measurement Bias', icon: 'eye', type: 'bias', q: 'Could the act of measuring or monitoring be influencing the results (Hawthorne effect)?', priority: 2 },
          { cat: 'Change Fatigue', icon: 'battery-low', type: 'context', q: 'Is your team experiencing change fatigue? Is now the right time for this change?', priority: 3 },
          { cat: 'Dependencies', icon: 'link', type: 'risk', q: 'What other systems or processes does this change depend on or affect?', priority: 3 }
        ],
        client: [
          { cat: 'Client Context', icon: 'building', type: 'context', q: 'Are you accounting for client-specific factors that might explain their unique patterns?', priority: 1 },
          { cat: 'Benchmark Fairness', icon: 'scale', type: 'logic', q: 'Is the comparison benchmark fair for this client\'s specific situation and constraints?', priority: 1 },
          { cat: 'Selection Bias', icon: 'filter', type: 'bias', q: 'Are you selectively presenting information that paints a particular picture?', priority: 1 },
          { cat: 'Trend vs. Point', icon: 'line-chart', type: 'data', q: 'Are you presenting a single point in time, or showing the full trend with context?', priority: 2 },
          { cat: 'Confidence Communication', icon: 'shield', type: 'data', q: 'Are you appropriately communicating uncertainty and confidence intervals?', priority: 2, tool: 'sampleCalc' },
          { cat: 'Actionability', icon: 'play', type: 'logic', q: 'Does your analysis lead to clear, actionable recommendations the client can implement?', priority: 2 },
          { cat: 'External Factors', icon: 'cloud', type: 'context', q: 'Are there external factors (market conditions, regulations) affecting this client differently?', priority: 3 },
          { cat: 'Relationship Impact', icon: 'heart', type: 'risk', q: 'How will this message be received? Have you considered the relationship implications?', priority: 3 }
        ],
        forecast: [
          { cat: 'Historical Reliability', icon: 'history', type: 'data', q: 'How accurate have similar forecasts been in the past? What\'s your track record?', priority: 1 },
          { cat: 'Assumption Testing', icon: 'help-circle', type: 'logic', q: 'What key assumptions is your forecast based on? What happens if they\'re wrong?', priority: 1 },
          { cat: 'Scenario Planning', icon: 'git-branch', type: 'logic', q: 'Have you modeled best-case, worst-case, and most-likely scenarios?', priority: 1 },
          { cat: 'External Factors', icon: 'cloud', type: 'context', q: 'What external factors could invalidate your forecast that aren\'t captured in historical data?', priority: 2 },
          { cat: 'Overconfidence', icon: 'alert-circle', type: 'bias', q: 'Are your confidence intervals appropriately wide? Forecasters typically underestimate uncertainty.', priority: 2 },
          { cat: 'Feedback Loops', icon: 'refresh-cw', type: 'logic', q: 'Could actions based on this forecast change the outcome itself (self-fulfilling or self-defeating)?', priority: 2 },
          { cat: 'Black Swans', icon: 'zap', type: 'risk', q: 'What rare but high-impact events could completely invalidate this forecast?', priority: 3 },
          { cat: 'Model Limitations', icon: 'box', type: 'data', q: 'What are the known limitations of your forecasting model or methodology?', priority: 3 }
        ]
      };

      // Universal challenges
      const universalChallenges = [
        { cat: 'Confirmation Bias', icon: 'thumbs-up', type: 'bias', q: 'Did you form this conclusion before or after looking at the data? Have you actively sought disconfirming evidence?', priority: 1, tool: 'biasChecker' },
        { cat: 'Sample Size', icon: 'users', type: 'data', q: `Is ${sample || 'your sample'} large enough to draw this conclusion with confidence?`, priority: 1, tool: 'sampleCalc' },
        { cat: 'Recency Bias', icon: 'clock', type: 'bias', q: 'Are you overweighting recent events while undervaluing longer-term patterns?', priority: 2 }
      ];

      // Dynamic challenges based on detected patterns
      const dynamicChallenges = [];

      if (patterns.find(p => p.type === 'percentage')) {
        dynamicChallenges.push({ cat: 'Percentage Context', icon: 'percent', type: 'data', q: 'What are the absolute numbers behind these percentages? Could small base sizes be inflating the apparent change?', priority: 1 });
      }
      if (patterns.find(p => p.type === 'small-sample')) {
        dynamicChallenges.push({ cat: 'Sample Size Warning', icon: 'alert-triangle', type: 'data', q: 'Your sample size appears small. Have you calculated confidence intervals? The true value could vary significantly.', priority: 1, tool: 'sampleCalc' });
      }
      if (patterns.find(p => p.type === 'threshold')) {
        dynamicChallenges.push({ cat: 'Threshold Arbitrariness', icon: 'target', type: 'logic', q: 'How was this threshold/SLA originally set? Is it still the right target, or should it be recalibrated?', priority: 2 });
      }
      if (patterns.find(p => p.type === 'expansion')) {
        dynamicChallenges.push({ cat: 'Growth Sustainability', icon: 'trending-up', type: 'risk', q: 'Is this expansion sustainable long-term? What happens if conditions change and you need to scale back?', priority: 2 });
      }
      if (patterns.find(p => p.type === 'reduction')) {
        dynamicChallenges.push({ cat: 'Reduction Risks', icon: 'alert-circle', type: 'risk', q: 'What capabilities or institutional knowledge might be lost? Are there non-obvious dependencies?', priority: 1 });
      }
      if (patterns.find(p => p.type === 'short-term')) {
        dynamicChallenges.push({ cat: 'Short-Term Thinking', icon: 'clock', type: 'context', q: 'Is this time period long enough to establish a reliable pattern? Short windows can be misleading.', priority: 2 });
      }

      // Combine and prioritize challenges
      const typeSpecific = challengeBank[type] || challengeBank.performance;
      let allChallenges = [...dynamicChallenges, ...typeSpecific, ...universalChallenges];

      // Sort by priority
      allChallenges.sort((a, b) => a.priority - b.priority);

      // Limit based on intensity
      const limits = { quick: 5, thorough: 9, rigorous: 15 };
      allChallenges = allChallenges.slice(0, limits[intensity]);

      // Generate pattern tags HTML
      const patternTags = patterns.length > 0 ? `
        <div style="margin-bottom: 16px;">
          <span class="muted" style="font-size: 12px;">Detected patterns in your input:</span>
          <div class="detected-patterns">
            ${patterns.map(p => `<span class="pattern-tag"><i data-lucide="${p.icon}" style="width:12px;height:12px;vertical-align:middle;margin-right:4px;"></i>${p.type.replace('-', ' ')}</span>`).join('')}
          </div>
        </div>
      ` : '';

      document.getElementById('challenge-results').innerHTML = `
        <div class="card warning">
          <h4 style="margin-top:0; display: flex; align-items: center; gap: 8px;">
            <i data-lucide="shield-alert" style="width:20px; height:20px; color:var(--amber);"></i>
            Devil's Advocate Challenge (${allChallenges.length} questions)
          </h4>

          ${patternTags}

          <div class="challenge-progress">
            <span class="muted" style="font-size: 12px;">Progress:</span>
            <div class="challenge-progress-bar">
              <div class="challenge-progress-fill" id="challenge-progress-fill" style="width: 0%;"></div>
            </div>
            <div class="challenge-progress-text" id="challenge-progress-text">0 / ${allChallenges.length}</div>
          </div>

          <div id="challenge-cards">
            ${allChallenges.map((c, i) => `
              <div class="challenge-card" id="challenge-${i}" data-index="${i}">
                <div class="challenge-card-header">
                  <div class="challenge-card-icon ${c.type}">
                    <i data-lucide="${c.icon}"></i>
                  </div>
                  <div class="challenge-card-content">
                    <div class="challenge-card-category">${c.cat}</div>
                    <div class="challenge-card-question">${c.q}</div>
                    ${c.tool ? `<div class="challenge-card-context">💡 Use the <a href="#${c.tool}" onclick="navigateTo('${c.tool}')">${getToolName(c.tool)}</a> to help answer this question.</div>` : ''}
                  </div>
                </div>
                <div class="challenge-card-actions">
                  <button class="challenge-action-btn" onclick="markChallenge(${i}, 'confident')">
                    <i data-lucide="check"></i> I'm Confident
                  </button>
                  <button class="challenge-action-btn" onclick="markChallenge(${i}, 'needs-work')">
                    <i data-lucide="alert-circle"></i> Needs Work
                  </button>
                </div>
              </div>
            `).join('')}
          </div>

          <div class="challenge-summary" id="challenge-summary" style="display: none;">
            <div class="challenge-summary-stat confident">
              <div class="stat-value" id="summary-confident">0</div>
              <div class="stat-label">Confident</div>
            </div>
            <div class="challenge-summary-stat needs-work">
              <div class="stat-value" id="summary-needs-work">0</div>
              <div class="stat-label">Needs Work</div>
            </div>
            <div class="challenge-summary-stat unanswered">
              <div class="stat-value" id="summary-unanswered">${allChallenges.length}</div>
              <div class="stat-label">Unanswered</div>
            </div>
          </div>

          <div class="export-bar">
            <button class="btn" onclick="exportChallenges()"><i data-lucide="download"></i>Export Worksheet</button>
            <button class="btn" onclick="resetChallenges()"><i data-lucide="refresh-cw"></i>Reset</button>
          </div>
        </div>
      `;
      renderIcons();
      document.getElementById('challenge-summary').style.display = 'grid';
    }

    function getToolName(tool) {
      const names = {
        sampleCalc: 'Sample Size Calculator',
        biasChecker: 'Bias Self-Check Tool',
        fiveWhys: '5 Whys Analysis'
      };
      return names[tool] || tool;
    }

    function markChallenge(index, status) {
      challengeState.responses[index] = status;
      const card = document.getElementById(`challenge-${index}`);
      card.classList.remove('answered', 'needs-work');
      card.classList.add(status === 'confident' ? 'answered' : 'needs-work');

      // Update buttons
      const buttons = card.querySelectorAll('.challenge-action-btn');
      buttons.forEach(btn => btn.classList.remove('confident', 'needs-work'));
      const activeBtn = status === 'confident' ? buttons[0] : buttons[1];
      activeBtn.classList.add(status);

      updateChallengeProgress();
    }

    function updateChallengeProgress() {
      const total = document.querySelectorAll('.challenge-card').length;
      const responses = Object.values(challengeState.responses);
      const confident = responses.filter(r => r === 'confident').length;
      const needsWork = responses.filter(r => r === 'needs-work').length;
      const answered = confident + needsWork;
      const unanswered = total - answered;

      const percent = Math.round((answered / total) * 100);
      document.getElementById('challenge-progress-fill').style.width = percent + '%';
      document.getElementById('challenge-progress-text').textContent = `${answered} / ${total}`;

      document.getElementById('summary-confident').textContent = confident;
      document.getElementById('summary-needs-work').textContent = needsWork;
      document.getElementById('summary-unanswered').textContent = unanswered;
    }

    function resetChallenges() {
      challengeState.responses = {};
      document.querySelectorAll('.challenge-card').forEach(card => {
        card.classList.remove('answered', 'needs-work');
        card.querySelectorAll('.challenge-action-btn').forEach(btn => btn.classList.remove('confident', 'needs-work'));
      });
      updateChallengeProgress();
    }

    function exportChallenges() {
      const conclusion = document.getElementById('chal-conclusion').value;
      const metrics = document.getElementById('chal-metrics').value;
      const period = document.getElementById('chal-period').value;
      const sample = document.getElementById('chal-sample').value;

      const cards = document.querySelectorAll('.challenge-card');
      const total = cards.length;
      const confident = Object.values(challengeState.responses).filter(r => r === 'confident').length;
      const needsWork = Object.values(challengeState.responses).filter(r => r === 'needs-work').length;

      let text = `ANALYSIS CHALLENGE WORKSHEET\n`;
      text += `Generated: ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}\n`;
      text += `Intensity: ${challengeState.intensity.toUpperCase()}\n`;
      text += `${'='.repeat(60)}\n\n`;
      text += `CONCLUSION UNDER REVIEW:\n${conclusion || 'Not specified'}\n\n`;
      text += `KEY METRICS: ${metrics || 'Not specified'}\n`;
      text += `TIME PERIOD: ${period || 'Not specified'}\n`;
      text += `SAMPLE SIZE: ${sample || 'Not specified'}\n\n`;
      text += `${'='.repeat(60)}\n\n`;
      text += `SUMMARY: ${confident} Confident | ${needsWork} Needs Work | ${total - confident - needsWork} Unanswered\n\n`;
      text += `${'='.repeat(60)}\n\n`;
      text += `CHALLENGE QUESTIONS:\n\n`;

      cards.forEach((card, i) => {
        const category = card.querySelector('.challenge-card-category').textContent;
        const question = card.querySelector('.challenge-card-question').textContent;
        const status = challengeState.responses[i] || 'unanswered';
        const statusEmoji = status === 'confident' ? '✅' : status === 'needs-work' ? '⚠️' : '⬜';

        text += `${i + 1}. [${statusEmoji}] ${category}\n`;
        text += `   ${question}\n\n`;
        text += `   YOUR RESPONSE:\n   _________________________________\n\n`;
      });

      downloadText(text, 'analysis-challenge-worksheet.txt');
    }

    // ===============================
    // INTERACTIVE TOOLS - CTQ TREE BUILDER (Lean Six Sigma)
    // ===============================
    let ctqAutoSaveTimer = null;
    let ctqExpandedHints = new Set();

    function getCTQState() {
      try { return JSON.parse(localStorage.getItem('dbp-ctq-state') || '{}'); }
      catch { return {}; }
    }
    function setCTQState(state) {
      localStorage.setItem('dbp-ctq-state', JSON.stringify(state));
    }

    function formatCTQLastSaved(timestamp) {
      if (!timestamp) return '';
      const date = new Date(timestamp);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);

      if (diffMins < 1) return 'just now';
      if (diffMins < 60) return `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
      if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
      return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }

    function updateCTQLastSavedDisplay() {
      const state = getCTQState();
      const el = document.getElementById('ctq-last-saved');
      if (el && state.lastSaved) {
        el.textContent = `Auto-saved ${formatCTQLastSaved(state.lastSaved)}`;
        el.style.opacity = '1';
      }
    }

    function autoSaveCTQ() {
      clearTimeout(ctqAutoSaveTimer);
      ctqAutoSaveTimer = setTimeout(() => {
        const state = {
          voc: document.getElementById('ctq-voc')?.value || '',
          driver1: document.getElementById('ctq-driver1')?.value || '',
          driver2: document.getElementById('ctq-driver2')?.value || '',
          driver3: document.getElementById('ctq-driver3')?.value || '',
          driver4: document.getElementById('ctq-driver4')?.value || '',
          metric1: document.getElementById('ctq-metric1')?.value || '',
          metric2: document.getElementById('ctq-metric2')?.value || '',
          metric3: document.getElementById('ctq-metric3')?.value || '',
          metric4: document.getElementById('ctq-metric4')?.value || '',
          lsl1: document.getElementById('ctq-lsl1')?.value || '',
          lsl2: document.getElementById('ctq-lsl2')?.value || '',
          lsl3: document.getElementById('ctq-lsl3')?.value || '',
          lsl4: document.getElementById('ctq-lsl4')?.value || '',
          target1: document.getElementById('ctq-target1')?.value || '',
          target2: document.getElementById('ctq-target2')?.value || '',
          target3: document.getElementById('ctq-target3')?.value || '',
          target4: document.getElementById('ctq-target4')?.value || '',
          usl1: document.getElementById('ctq-usl1')?.value || '',
          usl2: document.getElementById('ctq-usl2')?.value || '',
          usl3: document.getElementById('ctq-usl3')?.value || '',
          usl4: document.getElementById('ctq-usl4')?.value || '',
          defect: document.getElementById('ctq-defect')?.value || '',
          lastSaved: Date.now()
        };
        setCTQState(state);
        updateCTQLastSavedDisplay();
        updateCTQVisualization();
        updateCTQVisibility();
        updateCTQProgress();
      }, 800);
    }

    function updateCTQVisualization() {
      const vocEl = document.getElementById('ctq-viz-voc');
      const voc = document.getElementById('ctq-voc')?.value?.trim();
      if (vocEl) vocEl.textContent = voc || 'Stakeholder need...';

      for (let i = 1; i <= 4; i++) {
        const driver = document.getElementById(`ctq-driver${i}`)?.value?.trim();
        const metric = document.getElementById(`ctq-metric${i}`)?.value?.trim();
        const target = document.getElementById(`ctq-target${i}`)?.value?.trim();
        const lsl = document.getElementById(`ctq-lsl${i}`)?.value?.trim();
        const usl = document.getElementById(`ctq-usl${i}`)?.value?.trim();

        const dEl = document.getElementById(`ctq-viz-d${i}`);
        const tEl = document.getElementById(`ctq-viz-t${i}`);
        const branchEl = document.getElementById(`ctq-viz-branch${i}`);

        if (dEl) dEl.textContent = driver || '-';
        if (tEl) {
          const specs = [];
          if (metric) specs.push(`Metric: ${metric}`);
          if (lsl) specs.push(`LSL: ${lsl}`);
          if (target) specs.push(`Target: ${target}`);
          if (usl) specs.push(`USL: ${usl}`);
          tEl.textContent = specs.length > 0 ? specs.join(' | ') : 'Metric: - | Specs: -';
        }

        if (branchEl) {
          branchEl.style.display = driver ? 'block' : 'none';
        }
      }
    }

    function updateCTQVisibility() {
      // Progressive disclosure for Driver 4
      const driver3Value = document.getElementById('ctq-driver3')?.value?.trim();
      const driver4Container = document.getElementById('ctq-driver4-container');
      if (driver4Container) {
        driver4Container.style.display = driver3Value ? 'block' : 'none';
        driver4Container.style.opacity = driver3Value ? '1' : '0';
      }

      // Progressive disclosure for spec rows
      for (let i = 2; i <= 4; i++) {
        const prevDriverValue = document.getElementById(`ctq-driver${i-1}`)?.value?.trim();
        const specRow = document.getElementById(`ctq-spec-row${i}`);
        if (specRow) {
          specRow.style.display = prevDriverValue ? 'table-row' : 'none';
        }
      }

      // Update spec row driver labels
      for (let i = 1; i <= 4; i++) {
        const driverValue = document.getElementById(`ctq-driver${i}`)?.value?.trim();
        const labelEl = document.getElementById(`ctq-label${i}`);
        if (labelEl) {
          labelEl.textContent = driverValue || `Driver ${i}`;
        }
      }
    }

    function updateCTQProgress() {
      const state = getCTQState();

      // Calculate completion
      const hasVOC = state.voc?.trim()?.length > 0;
      const driverCount = [state.driver1, state.driver2, state.driver3, state.driver4]
        .filter(d => d?.trim()?.length > 0).length;
      const hasDrivers = driverCount >= 2;

      // Check if at least one driver has full specs
      let specsComplete = 0;
      for (let i = 1; i <= 4; i++) {
        const driver = state[`driver${i}`]?.trim();
        const metric = state[`metric${i}`]?.trim();
        const hasSpec = state[`lsl${i}`]?.trim() || state[`target${i}`]?.trim() || state[`usl${i}`]?.trim();
        if (driver && metric && hasSpec) specsComplete++;
      }
      const hasSpecs = specsComplete >= 1;
      const hasDefect = state.defect?.trim()?.length > 0;

      // Update step indicators
      const steps = [
        { id: 'ctq-step1-status', complete: hasVOC },
        { id: 'ctq-step2-status', complete: hasDrivers },
        { id: 'ctq-step3-status', complete: hasSpecs },
        { id: 'ctq-step4-status', complete: hasDefect }
      ];

      steps.forEach(step => {
        const el = document.getElementById(step.id);
        if (el) {
          el.innerHTML = step.complete
            ? '<i data-lucide="check" style="width:14px;height:14px;"></i>'
            : '';
          el.className = `ctq-step-status ${step.complete ? 'complete' : ''}`;
          if (typeof lucide !== 'undefined') lucide.createIcons();
        }
      });

      // Update overall progress
      const completedSteps = [hasVOC, hasDrivers, hasSpecs, hasDefect].filter(Boolean).length;
      const progressEl = document.getElementById('ctq-progress-text');
      if (progressEl) {
        progressEl.textContent = `${completedSteps}/4 steps complete`;
        progressEl.className = completedSteps === 4 ? 'ctq-progress-complete' : '';
      }

      // Update completion badge
      const badgeEl = document.getElementById('ctq-completion-badge');
      if (badgeEl) {
        badgeEl.style.display = completedSteps === 4 ? 'inline-flex' : 'none';
      }
    }

    function toggleCTQHint(hintId, event) {
      if (event) event.stopPropagation();
      if (ctqExpandedHints.has(hintId)) {
        ctqExpandedHints.delete(hintId);
      } else {
        ctqExpandedHints.add(hintId);
      }
      renderView('ctqBuilder');
    }

    function renderCTQStepHeader(num, color, title, subtitle) {
      return `
        <div style="display:flex; align-items:flex-start; gap:12px; margin-top:${num === 1 ? '0' : '24px'}; margin-bottom:12px;">
          <div style="
            display:flex;
            align-items:center;
            justify-content:center;
            min-width:32px;
            height:32px;
            background:var(--${color});
            color:white;
            border-radius:50%;
            font-size:14px;
            font-weight:600;
            position:relative;
          ">
            ${num}
            <span id="ctq-step${num}-status" class="ctq-step-status"></span>
          </div>
          <div style="flex:1;">
            <h4 style="margin:0; color:var(--${color});">${title}</h4>
            <p class="muted" style="margin:4px 0 0 0; font-size:13px;">${subtitle}</p>
          </div>
        </div>
      `;
    }

    function renderCTQHint(id, title, content) {
      const isExpanded = ctqExpandedHints.has(id);
      return `
        <div class="ctq-hint-toggle" onclick="toggleCTQHint('${id}', event)">
          <i data-lucide="chevron-${isExpanded ? 'up' : 'down'}" style="width:14px;height:14px;"></i>
          <span>${isExpanded ? 'Hide tips' : title}</span>
        </div>
        <div class="ctq-hint-content" style="display:${isExpanded ? 'block' : 'none'};">
          <i data-lucide="lightbulb" style="width:14px;height:14px;color:var(--amber);flex-shrink:0;"></i>
          <div>${content}</div>
        </div>
      `;
    }

    function renderCTQBuilder() {
      const state = getCTQState();
      const lastSavedText = state.lastSaved ? formatCTQLastSaved(state.lastSaved) : '';
      const hasDriver3 = state.driver3?.trim()?.length > 0;

      return `
        <style>
          .ctq-step-status {
            position:absolute;
            bottom:-2px;
            right:-2px;
            width:16px;
            height:16px;
            background:var(--panel);
            border-radius:50%;
            display:flex;
            align-items:center;
            justify-content:center;
          }
          .ctq-step-status.complete {
            background:var(--accent);
            color:white;
          }
          .ctq-hint-toggle {
            display:inline-flex;
            align-items:center;
            gap:4px;
            font-size:12px;
            color:var(--muted);
            cursor:pointer;
            padding:4px 8px;
            border-radius:4px;
            transition: background 0.2s;
          }
          .ctq-hint-toggle:hover {
            background:var(--bg);
            color:var(--text);
          }
          .ctq-hint-content {
            display:flex;
            gap:8px;
            background:rgba(251,191,36,.08);
            border-left:3px solid var(--amber);
            padding:12px;
            border-radius:0 8px 8px 0;
            margin-top:8px;
            font-size:13px;
            line-height:1.5;
          }
          .ctq-progress-header {
            display:flex;
            align-items:center;
            gap:8px;
            font-size:12px;
            color:var(--muted);
            background:var(--bg);
            padding:6px 12px;
            border-radius:20px;
          }
          .ctq-progress-complete {
            color:var(--accent) !important;
            font-weight:600;
          }
          .ctq-completion-badge {
            display:inline-flex;
            align-items:center;
            gap:4px;
            background:var(--accent);
            color:white;
            padding:4px 10px;
            border-radius:12px;
            font-size:11px;
            font-weight:600;
            animation: ctqPulse 2s ease-in-out infinite;
          }
          @keyframes ctqPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(16,185,129,.4); }
            50% { box-shadow: 0 0 0 6px rgba(16,185,129,0); }
          }
          .ctq-viz-branch {
            margin-left:20px;
            margin-top:8px;
            border-left:3px solid var(--border);
            padding-left:16px;
            transition: all 0.3s ease;
          }
          .ctq-spec-input {
            padding:6px 10px;
            font-size:13px;
          }
          .ctq-spec-input.small {
            width:80px;
          }
        </style>
        <div class="card tool">
          <div style="display:flex; justify-content:space-between; align-items:flex-start; flex-wrap:wrap; gap:12px;">
            <div>
              <h3 style="margin-bottom:4px;">CTQ Tree Builder</h3>
              <p style="margin:0;">Translate Voice of Customer (VOC) into measurable Critical-to-Quality requirements.</p>
            </div>
            <div style="display:flex; flex-direction:column; align-items:flex-end; gap:6px;">
              <div class="ctq-progress-header">
                <i data-lucide="check-circle" style="width:14px;height:14px;"></i>
                <span id="ctq-progress-text">0/4 steps complete</span>
              </div>
              <span id="ctq-completion-badge" class="ctq-completion-badge" style="display:none;">
                <i data-lucide="award" style="width:12px;height:12px;"></i>Ready to Export
              </span>
              <span id="ctq-last-saved" style="
                font-size:11px;
                color:var(--muted);
                opacity:${lastSavedText ? '1' : '0'};
                transition: opacity 0.3s ease;
              ">${lastSavedText ? `Auto-saved ${lastSavedText}` : ''}</span>
            </div>
          </div>

          <div style="margin-top: 24px;">
            ${renderCTQStepHeader(1, 'brand', 'Voice of Customer (VOC)', 'What is the stakeholder\'s need or concern in their own words?')}
            <div class="form-group">
              <label class="form-label">Stakeholder Need Statement</label>
              <textarea class="form-textarea" id="ctq-voc" placeholder="e.g., 'Claims are taking too long to process' or 'We need better accuracy on complex cases'" oninput="autoSaveCTQ()">${state.voc || ''}</textarea>
              ${renderCTQHint('voc', 'Tips for capturing VOC',
                '<strong>Good VOC examples:</strong><ul style="margin:8px 0 0 16px;padding:0;"><li>"Claims are taking too long to process"</li><li>"We need better accuracy on complex cases"</li><li>"Customers complain about inconsistent responses"</li></ul><strong>Avoid:</strong> Technical jargon or pre-interpreted statements. Capture raw customer language.'
              )}
            </div>

            ${renderCTQStepHeader(2, 'brand-2', 'CTQ Drivers', 'What quality characteristics would satisfy this need? (Usually 2-4 drivers)')}
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Driver 1 <span style="color:var(--danger);">*</span></label>
                <input type="text" class="form-input" id="ctq-driver1" placeholder="e.g., Processing Speed" value="${state.driver1 || ''}" oninput="autoSaveCTQ()">
              </div>
              <div class="form-group">
                <label class="form-label">Driver 2 <span style="color:var(--danger);">*</span></label>
                <input type="text" class="form-input" id="ctq-driver2" placeholder="e.g., Decision Accuracy" value="${state.driver2 || ''}" oninput="autoSaveCTQ()">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Driver 3</label>
                <input type="text" class="form-input" id="ctq-driver3" placeholder="e.g., Communication Clarity" value="${state.driver3 || ''}" oninput="autoSaveCTQ()">
              </div>
              <div class="form-group" id="ctq-driver4-container" style="display:${hasDriver3 ? 'block' : 'none'}; opacity:${hasDriver3 ? '1' : '0'}; transition: opacity 0.3s ease;">
                <label class="form-label">Driver 4</label>
                <input type="text" class="form-input" id="ctq-driver4" placeholder="Optional - add if needed" value="${state.driver4 || ''}" oninput="autoSaveCTQ()">
              </div>
            </div>
            ${renderCTQHint('drivers', 'Tips for identifying drivers',
              '<strong>Good drivers are:</strong><ul style="margin:8px 0 0 16px;padding:0;"><li><strong>Measurable</strong> - Can be quantified (speed, accuracy, completeness)</li><li><strong>Actionable</strong> - Your team can influence them</li><li><strong>Customer-focused</strong> - Directly tied to stakeholder satisfaction</li></ul><strong>Common categories:</strong> Speed, Accuracy, Completeness, Consistency, Cost'
            )}

            ${renderCTQStepHeader(3, 'accent', 'CTQ Specifications', 'Define measurable specifications for each driver')}
            <div style="margin-bottom:8px;">
              ${renderCTQHint('specs', 'Understanding LSL, Target, and USL',
                '<strong>Specification Limits:</strong><ul style="margin:8px 0 0 16px;padding:0;"><li><strong>LSL (Lower Spec Limit)</strong> - Minimum acceptable value (e.g., accuracy ≥95%)</li><li><strong>Target</strong> - Ideal/goal value to aim for</li><li><strong>USL (Upper Spec Limit)</strong> - Maximum acceptable value (e.g., TAT ≤30 days)</li></ul><strong>Note:</strong> Not all metrics need both LSL and USL. Use "-" for one-sided specs.'
              )}
            </div>
            <div style="overflow-x:auto;">
              <table class="table" style="margin-top:8px;">
                <thead>
                  <tr>
                    <th style="width:140px;">CTQ Driver</th>
                    <th>Metric</th>
                    <th style="width:90px;">LSL (Min)</th>
                    <th style="width:90px;">Target</th>
                    <th style="width:90px;">USL (Max)</th>
                  </tr>
                </thead>
                <tbody>
                  <tr id="ctq-spec-row1">
                    <td><span id="ctq-label1" style="font-weight:500;color:var(--brand);">${state.driver1 || 'Driver 1'}</span></td>
                    <td><input type="text" class="form-input ctq-spec-input" id="ctq-metric1" placeholder="e.g., TAT days" value="${state.metric1 || ''}" oninput="autoSaveCTQ()"></td>
                    <td><input type="text" class="form-input ctq-spec-input small" id="ctq-lsl1" placeholder="e.g., -" value="${state.lsl1 || ''}" oninput="autoSaveCTQ()"></td>
                    <td><input type="text" class="form-input ctq-spec-input small" id="ctq-target1" placeholder="e.g., 23" value="${state.target1 || ''}" oninput="autoSaveCTQ()"></td>
                    <td><input type="text" class="form-input ctq-spec-input small" id="ctq-usl1" placeholder="e.g., 30" value="${state.usl1 || ''}" oninput="autoSaveCTQ()"></td>
                  </tr>
                  <tr id="ctq-spec-row2" style="display:${state.driver1?.trim() ? 'table-row' : 'none'};">
                    <td><span id="ctq-label2" style="font-weight:500;color:var(--brand-2);">${state.driver2 || 'Driver 2'}</span></td>
                    <td><input type="text" class="form-input ctq-spec-input" id="ctq-metric2" placeholder="e.g., Accuracy %" value="${state.metric2 || ''}" oninput="autoSaveCTQ()"></td>
                    <td><input type="text" class="form-input ctq-spec-input small" id="ctq-lsl2" placeholder="e.g., 95%" value="${state.lsl2 || ''}" oninput="autoSaveCTQ()"></td>
                    <td><input type="text" class="form-input ctq-spec-input small" id="ctq-target2" placeholder="e.g., 98%" value="${state.target2 || ''}" oninput="autoSaveCTQ()"></td>
                    <td><input type="text" class="form-input ctq-spec-input small" id="ctq-usl2" placeholder="e.g., -" value="${state.usl2 || ''}" oninput="autoSaveCTQ()"></td>
                  </tr>
                  <tr id="ctq-spec-row3" style="display:${state.driver2?.trim() ? 'table-row' : 'none'};">
                    <td><span id="ctq-label3" style="font-weight:500;color:var(--accent);">${state.driver3 || 'Driver 3'}</span></td>
                    <td><input type="text" class="form-input ctq-spec-input" id="ctq-metric3" placeholder="e.g., Response time" value="${state.metric3 || ''}" oninput="autoSaveCTQ()"></td>
                    <td><input type="text" class="form-input ctq-spec-input small" id="ctq-lsl3" placeholder="" value="${state.lsl3 || ''}" oninput="autoSaveCTQ()"></td>
                    <td><input type="text" class="form-input ctq-spec-input small" id="ctq-target3" placeholder="" value="${state.target3 || ''}" oninput="autoSaveCTQ()"></td>
                    <td><input type="text" class="form-input ctq-spec-input small" id="ctq-usl3" placeholder="" value="${state.usl3 || ''}" oninput="autoSaveCTQ()"></td>
                  </tr>
                  <tr id="ctq-spec-row4" style="display:${state.driver3?.trim() ? 'table-row' : 'none'};">
                    <td><span id="ctq-label4" style="font-weight:500;color:var(--amber);">${state.driver4 || 'Driver 4'}</span></td>
                    <td><input type="text" class="form-input ctq-spec-input" id="ctq-metric4" placeholder="e.g., Cost per unit" value="${state.metric4 || ''}" oninput="autoSaveCTQ()"></td>
                    <td><input type="text" class="form-input ctq-spec-input small" id="ctq-lsl4" placeholder="" value="${state.lsl4 || ''}" oninput="autoSaveCTQ()"></td>
                    <td><input type="text" class="form-input ctq-spec-input small" id="ctq-target4" placeholder="" value="${state.target4 || ''}" oninput="autoSaveCTQ()"></td>
                    <td><input type="text" class="form-input ctq-spec-input small" id="ctq-usl4" placeholder="" value="${state.usl4 || ''}" oninput="autoSaveCTQ()"></td>
                  </tr>
                </tbody>
              </table>
            </div>

            ${renderCTQStepHeader(4, 'amber', 'Defect Definition', 'What constitutes a defect? (When does output fail to meet CTQ?)')}
            <div class="form-group">
              <label class="form-label">Defect Definition</label>
              <textarea class="form-textarea" id="ctq-defect" placeholder="e.g., 'A defect occurs when TAT exceeds 30 days OR accuracy falls below 95%'" oninput="autoSaveCTQ()">${state.defect || ''}</textarea>
              ${renderCTQHint('defect', 'Tips for defining defects',
                '<strong>A good defect definition:</strong><ul style="margin:8px 0 0 16px;padding:0;"><li>References your CTQ specifications directly</li><li>Uses clear AND/OR logic for multiple criteria</li><li>Is binary - something either is or isn\'t a defect</li></ul><strong>Template:</strong> "A defect occurs when [metric] exceeds [USL] OR falls below [LSL]"'
              )}
            </div>
          </div>

          <div class="export-bar">
            <button class="btn" onclick="clearCTQState()"><i data-lucide="trash-2"></i>Clear</button>
            <button class="btn" onclick="copyCTQToClipboard()"><i data-lucide="copy"></i>Copy</button>
            <button class="btn primary" onclick="exportCTQ()"><i data-lucide="download"></i>Export CTQ Tree</button>
          </div>
        </div>

        <div class="callout info">
          <strong>Why CTQ matters:</strong> Without clear CTQ specifications, you risk measuring the wrong things or setting arbitrary thresholds. CTQ ensures your analysis addresses what the customer actually values and provides objective success criteria.
        </div>

        <div class="card">
          <h3>CTQ Tree Visualization</h3>
          <p class="muted">Your CTQ tree flows from Voice of Customer to measurable specifications:</p>
          <div style="background:var(--bg); border-radius:12px; padding:20px; margin-top:12px; font-family:var(--font-mono); font-size:13px;">
            <div style="display:flex; align-items:center; gap:8px;">
              <span style="background:var(--brand); color:white; padding:2px 8px; border-radius:4px; font-size:11px; font-weight:600;">VOC</span>
              <span style="color:var(--brand); font-weight:500;">"<span id="ctq-viz-voc">${state.voc?.trim() || 'Stakeholder need...'}</span>"</span>
            </div>

            <div id="ctq-viz-branch1" class="ctq-viz-branch" style="border-color:var(--brand); display:${state.driver1?.trim() ? 'block' : 'none'};">
              <div style="color:var(--brand); font-weight:500;"><i data-lucide="git-branch" style="width:14px;height:14px;display:inline;vertical-align:middle;margin-right:4px;"></i><span id="ctq-viz-d1">${state.driver1?.trim() || '-'}</span></div>
              <div style="margin-left:20px; color:var(--muted); font-size:12px;"><span id="ctq-viz-t1">${formatCTQVizSpecs(state, 1)}</span></div>
            </div>

            <div id="ctq-viz-branch2" class="ctq-viz-branch" style="border-color:var(--brand-2); display:${state.driver2?.trim() ? 'block' : 'none'};">
              <div style="color:var(--brand-2); font-weight:500;"><i data-lucide="git-branch" style="width:14px;height:14px;display:inline;vertical-align:middle;margin-right:4px;"></i><span id="ctq-viz-d2">${state.driver2?.trim() || '-'}</span></div>
              <div style="margin-left:20px; color:var(--muted); font-size:12px;"><span id="ctq-viz-t2">${formatCTQVizSpecs(state, 2)}</span></div>
            </div>

            <div id="ctq-viz-branch3" class="ctq-viz-branch" style="border-color:var(--accent); display:${state.driver3?.trim() ? 'block' : 'none'};">
              <div style="color:var(--accent); font-weight:500;"><i data-lucide="git-branch" style="width:14px;height:14px;display:inline;vertical-align:middle;margin-right:4px;"></i><span id="ctq-viz-d3">${state.driver3?.trim() || '-'}</span></div>
              <div style="margin-left:20px; color:var(--muted); font-size:12px;"><span id="ctq-viz-t3">${formatCTQVizSpecs(state, 3)}</span></div>
            </div>

            <div id="ctq-viz-branch4" class="ctq-viz-branch" style="border-color:var(--amber); display:${state.driver4?.trim() ? 'block' : 'none'};">
              <div style="color:var(--amber); font-weight:500;"><i data-lucide="git-branch" style="width:14px;height:14px;display:inline;vertical-align:middle;margin-right:4px;"></i><span id="ctq-viz-d4">${state.driver4?.trim() || '-'}</span></div>
              <div style="margin-left:20px; color:var(--muted); font-size:12px;"><span id="ctq-viz-t4">${formatCTQVizSpecs(state, 4)}</span></div>
            </div>

            ${!state.driver1?.trim() ? '<div style="color:var(--muted); font-style:italic; margin-top:12px;">Start typing above to see your CTQ tree take shape...</div>' : ''}
          </div>
        </div>
      `;
    }

    function formatCTQVizSpecs(state, num) {
      const metric = state[`metric${num}`]?.trim();
      const lsl = state[`lsl${num}`]?.trim();
      const target = state[`target${num}`]?.trim();
      const usl = state[`usl${num}`]?.trim();

      if (!metric && !lsl && !target && !usl) return 'Metric: - | Specs: -';

      const specs = [];
      if (metric) specs.push(`Metric: ${metric}`);
      if (lsl) specs.push(`LSL: ${lsl}`);
      if (target) specs.push(`Target: ${target}`);
      if (usl) specs.push(`USL: ${usl}`);

      return specs.join(' | ');
    }

    function initCTQ() {
      if (typeof lucide !== 'undefined') {
        lucide.createIcons();
      }
      setTimeout(() => {
        updateCTQVisibility();
        updateCTQVisualization();
        updateCTQProgress();
      }, 50);
    }

    function clearCTQState() {
      if (confirm('Clear all CTQ data? This cannot be undone.')) {
        setCTQState({});
        ctqExpandedHints.clear();
        renderView('ctqBuilder');
      }
    }

    function copyCTQToClipboard() {
      const text = generateCTQExportText();
      navigator.clipboard.writeText(text).then(() => {
        toast('CTQ analysis copied to clipboard');
      }).catch(() => {
        toast('Failed to copy to clipboard');
      });
    }

    function generateCTQExportText() {
      const s = getCTQState();
      const date = new Date().toLocaleDateString();
      const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

      let text = `CTQ TREE ANALYSIS\n`;
      text += `Generated: ${date} at ${time}\n`;
      text += `${'='.repeat(60)}\n\n`;
      text += `VOICE OF CUSTOMER (VOC)\n`;
      text += `${'-'.repeat(40)}\n`;
      text += `${s.voc || 'Not specified'}\n\n`;
      text += `CTQ DRIVERS\n`;
      text += `${'-'.repeat(40)}\n`;
      if (s.driver1) text += `1. ${s.driver1}\n`;
      if (s.driver2) text += `2. ${s.driver2}\n`;
      if (s.driver3) text += `3. ${s.driver3}\n`;
      if (s.driver4) text += `4. ${s.driver4}\n`;
      text += `\n`;
      text += `CTQ SPECIFICATIONS\n`;
      text += `${'-'.repeat(40)}\n`;

      for (let i = 1; i <= 4; i++) {
        const driver = s[`driver${i}`];
        if (driver) {
          text += `Driver ${i}: ${driver}\n`;
          text += `  Metric: ${s[`metric${i}`] || '-'}\n`;
          text += `  LSL: ${s[`lsl${i}`] || '-'} | Target: ${s[`target${i}`] || '-'} | USL: ${s[`usl${i}`] || '-'}\n\n`;
        }
      }

      text += `DEFECT DEFINITION\n`;
      text += `${'-'.repeat(40)}\n`;
      text += `${s.defect || 'Not specified'}\n\n`;
      text += `${'='.repeat(60)}\n`;
      text += `Use these CTQ specifications to guide your Phase 1 framing.\n`;

      return text;
    }

    function exportCTQ() {
      const text = generateCTQExportText();
      downloadText(text, 'ctq-tree-analysis.txt');
      toast('CTQ analysis exported');
    }

    // ===============================
    // INTERACTIVE TOOLS - 5 WHYS ANALYSIS (Lean Six Sigma)
    // ===============================
    let fiveWhysAutoSaveTimer = null;

    function getFiveWhysState() {
      try { return JSON.parse(localStorage.getItem('dbp-5whys-state') || '{}'); }
      catch { return {}; }
    }

    function setFiveWhysState(state) {
      localStorage.setItem('dbp-5whys-state', JSON.stringify(state));
    }

    function formatLastSaved(timestamp) {
      if (!timestamp) return '';
      const date = new Date(timestamp);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);

      if (diffMins < 1) return 'just now';
      if (diffMins < 60) return `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
      if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
      return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }

    function updateLastSavedDisplay() {
      const state = getFiveWhysState();
      const el = document.getElementById('whys-last-saved');
      if (el && state.lastSaved) {
        el.textContent = `Auto-saved ${formatLastSaved(state.lastSaved)}`;
        el.style.opacity = '1';
      }
    }

    function autoSaveFiveWhys() {
      clearTimeout(fiveWhysAutoSaveTimer);
      fiveWhysAutoSaveTimer = setTimeout(() => {
        const state = {
          problem: document.getElementById('whys-problem')?.value || '',
          why1: document.getElementById('whys-1')?.value || '',
          why2: document.getElementById('whys-2')?.value || '',
          why3: document.getElementById('whys-3')?.value || '',
          why4: document.getElementById('whys-4')?.value || '',
          why5: document.getElementById('whys-5')?.value || '',
          rootCauseLevel: document.querySelector('input[name="root-cause-level"]:checked')?.value || '',
          category: document.getElementById('whys-category')?.value || '',
          countermeasure: document.getElementById('whys-countermeasure')?.value || '',
          verification: document.getElementById('whys-verification')?.value || '',
          lastSaved: Date.now()
        };
        setFiveWhysState(state);
        updateLastSavedDisplay();
        updateWhysVisibility();
      }, 800);
    }

    function updateWhysVisibility() {
      const state = getFiveWhysState();
      const rootLevel = parseInt(state.rootCauseLevel) || 0;

      for (let i = 2; i <= 5; i++) {
        const container = document.getElementById(`whys-${i}-container`);
        const prevValue = document.getElementById(`whys-${i-1}`)?.value?.trim();

        if (container) {
          // Hide if previous Why is empty OR if a root cause is marked before this level
          const shouldHide = !prevValue || (rootLevel > 0 && i > rootLevel);
          container.style.display = shouldHide ? 'none' : 'block';
          container.style.opacity = shouldHide ? '0' : '1';
        }
      }

      // Update root cause indicators
      for (let i = 1; i <= 5; i++) {
        const indicator = document.getElementById(`whys-${i}-root-indicator`);
        const radioContainer = document.getElementById(`whys-${i}-radio-container`);
        if (indicator) {
          indicator.style.display = (rootLevel === i) ? 'inline-flex' : 'none';
        }
        if (radioContainer) {
          // Show radio only if this field has content
          const hasContent = document.getElementById(`whys-${i}`)?.value?.trim();
          radioContainer.style.display = hasContent ? 'flex' : 'none';
        }
      }
    }

    function markAsRootCause(level) {
      const state = getFiveWhysState();
      // Toggle: if already marked, unmark it
      state.rootCauseLevel = (state.rootCauseLevel === String(level)) ? '' : String(level);
      state.lastSaved = Date.now();
      setFiveWhysState(state);
      updateWhysVisibility();
      updateLastSavedDisplay();
    }

    function renderWhyStep(num, color, prevColor, label, placeholder, value, rootCauseLevel, isFirst = false) {
      const isRootCause = rootCauseLevel === String(num);
      const hasValue = value && value.trim();

      const stepStyle = isFirst ? '' : `
        margin-left: ${(num - 1) * 16}px;
        padding-left: 20px;
        border-left: 3px solid var(--${prevColor});
        position: relative;
      `;

      const containerStyle = isFirst ? '' : `
        transition: opacity 0.3s ease, max-height 0.3s ease;
      `;

      return `
        <div id="whys-${num}-container" style="${containerStyle}">
          <div class="form-group" style="${stepStyle}">
            <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
              <span style="
                display:inline-flex;
                align-items:center;
                justify-content:center;
                width:24px;
                height:24px;
                background:var(--${color});
                color:white;
                border-radius:50%;
                font-size:12px;
                font-weight:600;
              ">${num}</span>
              <label class="form-label" style="color:var(--${color}); margin-bottom:0; flex:1;">
                ${label}
              </label>
              <span id="whys-${num}-root-indicator" style="
                display:${isRootCause ? 'inline-flex' : 'none'};
                align-items:center;
                gap:4px;
                background:var(--danger);
                color:white;
                padding:2px 8px;
                border-radius:12px;
                font-size:11px;
                font-weight:600;
              "><i data-lucide="target" style="width:12px;height:12px;"></i>ROOT CAUSE</span>
            </div>
            <textarea
              class="form-textarea"
              id="whys-${num}"
              placeholder="${placeholder}"
              oninput="autoSaveFiveWhys()"
              style="${isRootCause ? 'border-color:var(--danger); box-shadow:0 0 0 3px rgba(239,68,68,.15);' : ''}"
            >${value || ''}</textarea>
            <div id="whys-${num}-radio-container" style="display:${hasValue ? 'flex' : 'none'}; align-items:center; gap:6px; margin-top:6px;">
              <input
                type="radio"
                name="root-cause-level"
                id="root-cause-${num}"
                value="${num}"
                ${isRootCause ? 'checked' : ''}
                onchange="markAsRootCause(${num})"
                style="margin:0; accent-color:var(--danger);"
              >
              <label for="root-cause-${num}" style="font-size:12px; color:var(--muted); cursor:pointer; margin:0;">
                Mark as root cause
              </label>
            </div>
          </div>
          ${num < 5 ? `<div style="
            margin-left: ${num * 16 + 10}px;
            width: 2px;
            height: 12px;
            background: linear-gradient(to bottom, var(--${color}), var(--${getNextColor(num)}));
            opacity: 0.5;
          "></div>` : ''}
        </div>
      `;
    }

    function getNextColor(num) {
      const colors = ['brand', 'brand-2', 'accent', 'amber', 'danger'];
      return colors[num] || 'danger';
    }

    function renderFiveWhys() {
      const state = getFiveWhysState();
      const rootLevel = state.rootCauseLevel || '';

      return `
        <div class="card tool">
          <div style="display:flex; justify-content:space-between; align-items:flex-start; flex-wrap:wrap; gap:8px;">
            <div>
              <h3 style="margin-bottom:4px;">5 Whys Root Cause Analysis</h3>
              <p style="margin:0;">Use this Lean Six Sigma technique to drill down from symptoms to root causes.</p>
            </div>
            <span id="whys-last-saved" style="
              font-size:12px;
              color:var(--muted);
              background:var(--bg);
              padding:4px 10px;
              border-radius:12px;
              opacity:${state.lastSaved ? '1' : '0'};
              transition: opacity 0.3s ease;
            ">${state.lastSaved ? `Auto-saved ${formatLastSaved(state.lastSaved)}` : ''}</span>
          </div>

          <div style="margin-top: 20px;">
            <div class="form-group">
              <label class="form-label">Problem Statement</label>
              <textarea class="form-textarea" id="whys-problem" placeholder="e.g., 'TAT has increased from 23 days to 27 days over the past quarter'" oninput="autoSaveFiveWhys()">${state.problem || ''}</textarea>
              <p class="form-hint">Be specific about what is happening, when, and the magnitude</p>
            </div>

            <div style="background:var(--bg); border-radius:12px; padding:20px; margin-top:20px;">
              ${renderWhyStep(1, 'brand', '', 'Why is this happening?', 'First-level cause...', state.why1, rootLevel, true)}
              ${renderWhyStep(2, 'brand-2', 'brand', 'Why is that?', 'Second-level cause...', state.why2, rootLevel)}
              ${renderWhyStep(3, 'accent', 'brand-2', 'Why is that?', 'Third-level cause...', state.why3, rootLevel)}
              ${renderWhyStep(4, 'amber', 'accent', 'Why is that?', 'Fourth-level cause...', state.why4, rootLevel)}
              ${renderWhyStep(5, 'danger', 'amber', 'Why is that?', 'The fundamental reason...', state.why5, rootLevel)}
            </div>

            <div class="form-group" style="margin-top:20px;">
              <label class="form-label">Root Cause Category</label>
              <select class="form-select" id="whys-category" onchange="autoSaveFiveWhys()">
                <option value="">Select category (Fishbone/Ishikawa)</option>
                <option value="People" ${state.category === 'People' ? 'selected' : ''}>People - Skills, training, staffing</option>
                <option value="Process" ${state.category === 'Process' ? 'selected' : ''}>Process - Workflow, procedures, handoffs</option>
                <option value="Technology" ${state.category === 'Technology' ? 'selected' : ''}>Technology - Systems, tools, automation</option>
                <option value="Policy" ${state.category === 'Policy' ? 'selected' : ''}>Policy - Rules, requirements, constraints</option>
                <option value="Environment" ${state.category === 'Environment' ? 'selected' : ''}>Environment - External factors, market conditions</option>
                <option value="Measurement" ${state.category === 'Measurement' ? 'selected' : ''}>Measurement - Data quality, metrics definition</option>
              </select>
              <p class="form-hint">Categorizing helps identify appropriate countermeasures</p>
            </div>

            <div class="form-group">
              <label class="form-label">Proposed Countermeasure</label>
              <textarea class="form-textarea" id="whys-countermeasure" placeholder="What action would address the root cause and prevent recurrence?" oninput="autoSaveFiveWhys()">${state.countermeasure || ''}</textarea>
            </div>

            <div class="form-group">
              <label class="form-label">Verification Method</label>
              <textarea class="form-textarea" id="whys-verification" placeholder="How will you verify the countermeasure is effective?" oninput="autoSaveFiveWhys()">${state.verification || ''}</textarea>
            </div>
          </div>

          <div class="export-bar">
            <button class="btn" onclick="clearFiveWhysState()"><i data-lucide="trash-2"></i>Clear</button>
            <button class="btn" onclick="copyFiveWhysToClipboard()"><i data-lucide="copy"></i>Copy</button>
            <button class="btn primary" onclick="exportFiveWhys()"><i data-lucide="download"></i>Export Analysis</button>
          </div>
        </div>

        <div class="callout">
          <strong>Tips for effective 5 Whys:</strong>
          <ul style="margin:8px 0 0 0;">
            <li>Focus on process and systems, not people or blame</li>
            <li>Each "why" should logically follow from the previous answer</li>
            <li>You may need fewer or more than 5 whys - use "Mark as root cause" when you've found the actionable cause</li>
            <li>Consider multiple branches if there are multiple contributing causes</li>
          </ul>
        </div>

        <div class="card">
          <h3>Example: TAT Increase Analysis</h3>
          <table class="table">
            <tbody>
              <tr><td style="width:100px;"><strong>Problem</strong></td><td>TAT increased from 23 to 27 days</td></tr>
              <tr><td><strong>Why 1</strong></td><td>Claims are sitting in queue longer before assignment</td></tr>
              <tr><td><strong>Why 2</strong></td><td>Specialists are at capacity with current workload</td></tr>
              <tr><td><strong>Why 3</strong></td><td>Claim volume increased 15% while headcount remained flat</td></tr>
              <tr><td><strong>Why 4</strong></td><td>New client onboarding wasn't reflected in capacity planning</td></tr>
              <tr><td><strong>Why 5</strong></td><td>No formal process to update capacity model when new clients added</td></tr>
              <tr style="background:rgba(16,185,129,.1);"><td><strong>Root Cause</strong></td><td><strong>Process gap:</strong> Capacity planning not integrated with client onboarding</td></tr>
            </tbody>
          </table>
        </div>
      `;
    }

    function initFiveWhys() {
      // Re-initialize Lucide icons for dynamically rendered content
      if (typeof lucide !== 'undefined') {
        lucide.createIcons();
      }
      // Update visibility based on current state
      setTimeout(updateWhysVisibility, 50);
    }

    function saveFiveWhysState() {
      const state = {
        problem: document.getElementById('whys-problem')?.value || '',
        why1: document.getElementById('whys-1')?.value || '',
        why2: document.getElementById('whys-2')?.value || '',
        why3: document.getElementById('whys-3')?.value || '',
        why4: document.getElementById('whys-4')?.value || '',
        why5: document.getElementById('whys-5')?.value || '',
        rootCauseLevel: document.querySelector('input[name="root-cause-level"]:checked')?.value || '',
        category: document.getElementById('whys-category')?.value || '',
        countermeasure: document.getElementById('whys-countermeasure')?.value || '',
        verification: document.getElementById('whys-verification')?.value || '',
        lastSaved: Date.now()
      };
      setFiveWhysState(state);
      updateLastSavedDisplay();
    }

    function clearFiveWhysState() {
      if (confirm('Clear all 5 Whys data? This cannot be undone.')) {
        setFiveWhysState({});
        renderView('fiveWhys');
      }
    }

    function generateFiveWhysText() {
      const s = getFiveWhysState();
      const date = new Date().toLocaleDateString();
      const rootLevel = parseInt(s.rootCauseLevel) || 5;

      let text = `5 WHYS ROOT CAUSE ANALYSIS\n`;
      text += `Generated: ${date}\n`;
      text += `${'='.repeat(60)}\n\n`;
      text += `PROBLEM STATEMENT\n`;
      text += `${'-'.repeat(40)}\n`;
      text += `${s.problem || 'Not specified'}\n\n`;
      text += `ROOT CAUSE ANALYSIS\n`;
      text += `${'-'.repeat(40)}\n`;

      const whys = [s.why1, s.why2, s.why3, s.why4, s.why5];
      const indents = ['', '  ', '    ', '      ', '        '];

      for (let i = 0; i < 5; i++) {
        if (whys[i] && whys[i].trim()) {
          const isRoot = (i + 1) === rootLevel;
          const label = isRoot ? `Why #${i + 1} (ROOT CAUSE)` : `Why #${i + 1}`;
          text += `${indents[i]}${label}: ${whys[i]}\n`;
          if (isRoot) break;
        } else if (i === 0) {
          text += `Why #1: -\n`;
          break;
        } else {
          break;
        }
      }

      text += `\nROOT CAUSE CATEGORY: ${s.category || 'Not categorized'}\n\n`;
      text += `COUNTERMEASURE\n`;
      text += `${'-'.repeat(40)}\n`;
      text += `${s.countermeasure || 'Not specified'}\n\n`;
      text += `VERIFICATION METHOD\n`;
      text += `${'-'.repeat(40)}\n`;
      text += `${s.verification || 'Not specified'}\n\n`;
      text += `${'='.repeat(60)}\n`;
      text += `Use this analysis to inform your decision and monitoring plan.\n`;

      return text;
    }

    function exportFiveWhys() {
      saveFiveWhysState();
      const text = generateFiveWhysText();
      downloadText(text, '5-whys-analysis.txt');
    }

    function copyFiveWhysToClipboard() {
      saveFiveWhysState();
      const text = generateFiveWhysText();
      navigator.clipboard.writeText(text).then(() => {
        toast('Analysis copied to clipboard');
      }).catch(() => {
        // Fallback for older browsers
        const textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        toast('Analysis copied to clipboard');
      });
    }

    // ===============================
    // DOWNLOAD UTILITY
    // ===============================
    function downloadText(content, filename, type = 'text/plain') {
      const blob = new Blob([content], { type: `${type};charset=utf-8` });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      toast(`Downloaded ${filename}`);
    }

    // ===============================
    // CONTENT VIEWS
    // ===============================
    const views = {
      overview: () => `
        <div class="card">
          <p><strong>Start with questions, not data — Drive continuous improvement through evidence.</strong> Define what decision you're making, identify what could bias your thinking, then gather and interpret evidence. This approach prevents common mistakes by forcing clear questions, hypotheses, and thresholds up front—so you collect the right evidence and let that evidence drive decisions.</p>
          <p class="muted" style="margin-top:12px; font-size:13px;"><em>This framework integrates Lean Six Sigma DMAIC methodology and SAFe (Scaled Agile) principles for enterprise-grade rigor and continuous improvement.</em></p>
        </div>

        <div class="card">
          <h3>Methodology Alignment</h3>
          <p>Our five phases map directly to the <strong>DMAIC</strong> (Define, Measure, Analyze, Improve, Control) methodology used in Lean Six Sigma, with SAFe's built-in quality principles applied at every stage:</p>
          <table class="table" style="margin-top:12px;">
            <thead>
              <tr><th>Phase</th><th>DMAIC</th><th>SAFe Principle</th><th>Key Output</th></tr>
            </thead>
            <tbody>
              <tr><td>1. Frame Decision</td><td><strong>Define</strong></td><td>Customer Centricity</td><td>CTQ requirements & SMART question</td></tr>
              <tr><td>2. Extract Data</td><td><strong>Measure</strong></td><td>Built-in Quality</td><td>Validated dataset with MSA</td></tr>
              <tr><td>3. Interpret</td><td><strong>Analyze</strong></td><td>Transparency</td><td>Root cause identification</td></tr>
              <tr><td>4. Bias Detection</td><td><em>Cross-cutting</em></td><td>Built-in Quality</td><td>Validated conclusions</td></tr>
              <tr><td>5. Translate & Control</td><td><strong>Improve + Control</strong></td><td>Relentless Improvement</td><td>Action plan + control limits</td></tr>
            </tbody>
          </table>
        </div>

        <div class="card">
          <h3>Audience</h3>
          <p><strong>Business Users & Managers</strong> — Focus on Phases 1, 3, and 5. Understand and validate Phases 2 and 4 at a high level. Equivalent to <em>Product Owner</em> role in SAFe.</p>
          <p><strong>Analysts & Consultants</strong> — Engage deeply with all five phases to ensure rigor throughout. Equivalent to <em>Team Member / Subject Matter Expert</em> in SAFe.</p>
          <p><strong>Data Professionals</strong> — Own methodology compliance and quality gates. Equivalent to <em>Scrum Master / RTE</em> in SAFe for process governance.</p>
        </div>

        <div class="card">
          <h3>The Five Phases with Exit Criteria</h3>
          <p class="muted" style="margin-bottom:12px;">Each phase includes a <strong>Definition of Done (DoD)</strong> — clear tollgate criteria that must be met before proceeding. This ensures built-in quality at every step.</p>
          <ol>
            <li><strong>Frame the Decision</strong> — Define SMART questions before touching data
              <br><span class="muted" style="font-size:13px;">DoD: CTQ identified, hypothesis documented, success threshold defined</span></li>
            <li><strong>Extract Data Systematically</strong> — Use certified datasets and consistent methods
              <br><span class="muted" style="font-size:13px;">DoD: Data source validated, filters documented, sample size confirmed</span></li>
            <li><strong>Interpret with Rigor</strong> — Apply context, statistical significance, and seasonality
              <br><span class="muted" style="font-size:13px;">DoD: Confidence intervals calculated, comparisons contextualized, root cause explored</span></li>
            <li><strong>Apply Bias Detection</strong> — Actively identify and mitigate cognitive biases
              <br><span class="muted" style="font-size:13px;">DoD: Bias checklist completed, disconfirming evidence sought, peer review done</span></li>
            <li><strong>Translate to Decisions & Control</strong> — Document rationale, implement action, establish monitoring
              <br><span class="muted" style="font-size:13px;">DoD: Decision documented, control limits set, response triggers defined, owner assigned</span></li>
          </ol>
        </div>

        <div class="card">
          <h3>Cadence & Review Cycles</h3>
          <p>Aligned with SAFe iteration patterns, establish regular review cadences to ensure continuous improvement:</p>
          <div class="result-grid" style="margin-top:12px;">
            <div class="result-stat">
              <div class="stat-value" style="font-size:18px;">Weekly</div>
              <div class="stat-label">Operational Metrics</div>
            </div>
            <div class="result-stat">
              <div class="stat-value" style="font-size:18px;">Monthly</div>
              <div class="stat-label">Trend Analysis</div>
            </div>
            <div class="result-stat">
              <div class="stat-value" style="font-size:18px;">Quarterly</div>
              <div class="stat-label">Strategic Review</div>
            </div>
          </div>
          <ul style="margin-top:16px;">
            <li><strong>Weekly Stand-up:</strong> Review control chart status, flag out-of-control signals</li>
            <li><strong>Monthly Retrospective:</strong> Validate hypotheses, update baselines, identify improvement opportunities</li>
            <li><strong>Quarterly PI Review:</strong> Strategic alignment, reset control limits, celebrate wins, plan next increment</li>
          </ul>
        </div>

        <div class="card tool">
          <h3>Interactive Tools</h3>
          <p>This guide includes interactive tools aligned with Lean Six Sigma and SAFe methodologies:</p>
          <ul>
            <li><strong><a href="#ctqBuilder" onclick="navigateTo('ctqBuilder')" style="color:var(--brand)">CTQ Tree Builder</a></strong> <span class="muted">(NEW)</span> — Identify Critical-to-Quality requirements from Voice of Customer</li>
            <li><strong><a href="#fiveWhys" onclick="navigateTo('fiveWhys')" style="color:var(--brand)">5 Whys Analysis</a></strong> <span class="muted">(NEW)</span> — Root cause analysis tool for drilling into problems</li>
            <li><strong><a href="#biasChecker" onclick="navigateTo('biasChecker')" style="color:var(--brand)">Bias Self-Check</a></strong> — Interactive checklist with progress tracking and export</li>
            <li><strong><a href="#sampleCalc" onclick="navigateTo('sampleCalc')" style="color:var(--brand)">Sample Size Calculator</a></strong> — Calculate confidence intervals and assess statistical precision</li>
            <li><strong><a href="#decisionTemplate" onclick="navigateTo('decisionTemplate')" style="color:var(--brand)">Decision Template</a></strong> — Generate professional decision documentation</li>
            <li><strong><a href="#challengeMode" onclick="navigateTo('challengeMode')" style="color:var(--brand)">Challenge My Analysis</a></strong> — Devil's advocate questions tailored to your analysis type</li>
          </ul>
        </div>

        <div class="callout success">
          <strong>Continuous Improvement Mindset:</strong> This framework is not a one-time checklist. Use it iteratively — each decision cycle should inform and improve the next. Document lessons learned and update your control limits based on actual performance.
        </div>
      `,
      
      phase1: () => `
        <div class="callout"><strong>Why it matters:</strong> Poor framing leads to wasted analysis, misleading conclusions, and bad decisions. Invest <strong>10–15 minutes</strong> here to save hours later.</div>

        <div class="card">
          <h3>SMART Questions Framework</h3>

          <div class="smart-item">
            <div class="smart-letter">S</div>
            <div class="smart-content">
              <h4><i data-lucide="crosshair"></i> Specific</h4>
              <p>Define exactly what you're trying to decide, including the metric, threshold, timeframe, and standard.</p>
              <div class="example-compare">
                <div class="example-box bad">
                  <div class="example-label"><i data-lucide="x-circle"></i> Too vague</div>
                  "Are we staffed appropriately?"
                </div>
                <div class="example-box good">
                  <div class="example-label"><i data-lucide="check-circle"></i> Better</div>
                  "Do we have sufficient specialists to maintain 95% claims processed within 30 days given Q4 volume patterns?"
                </div>
              </div>
            </div>
          </div>

          <div class="smart-item">
            <div class="smart-letter">M</div>
            <div class="smart-content">
              <h4><i data-lucide="bar-chart-3"></i> Measurable</h4>
              <p>Identify specific metrics before analysis. Write these down to prevent cherry-picking favorable metrics later.</p>
              <div class="example-compare">
                <div class="example-box bad">
                  <div class="example-label"><i data-lucide="x-circle"></i> Too vague</div>
                  "We'll look at performance data."
                </div>
                <div class="example-box good">
                  <div class="example-label"><i data-lucide="check-circle"></i> Better</div>
                  "We'll measure: claims per specialist, average handling time, queue depth, TAT performance, utilization rate."
                </div>
              </div>
            </div>
          </div>

          <div class="smart-item">
            <div class="smart-letter">A</div>
            <div class="smart-content">
              <h4><i data-lucide="zap"></i> Action-Oriented</h4>
              <p>Connect your question to a decision with consequences. If no action will result, question whether the analysis is necessary.</p>
              <div class="example-compare">
                <div class="example-box bad">
                  <div class="example-label"><i data-lucide="x-circle"></i> Too vague</div>
                  "What does our claims data look like?"
                </div>
                <div class="example-box good">
                  <div class="example-label"><i data-lucide="check-circle"></i> Better</div>
                  "Should we hire 2 additional specialists or redistribute existing workload to meet SLA?"
                </div>
              </div>
            </div>
          </div>

          <div class="smart-item">
            <div class="smart-letter">R</div>
            <div class="smart-content">
              <h4><i data-lucide="compass"></i> Relevant</h4>
              <p>Ensure the question matters to business outcomes. Document why it matters now, who needs the answer, and the impact.</p>
              <div class="example-compare">
                <div class="example-box bad">
                  <div class="example-label"><i data-lucide="x-circle"></i> Too vague</div>
                  "Interesting trend in the data."
                </div>
                <div class="example-box good">
                  <div class="example-label"><i data-lucide="check-circle"></i> Better</div>
                  "VP of Operations needs this by Friday to finalize Q1 budget. Missing SLA costs $50K/month in penalties."
                </div>
              </div>
            </div>
          </div>

          <div class="smart-item">
            <div class="smart-letter">T</div>
            <div class="smart-content">
              <h4><i data-lucide="clock"></i> Time-Bound</h4>
              <p>Define comparison periods explicitly to account for seasonal patterns and ensure apples-to-apples comparisons.</p>
              <div class="example-compare">
                <div class="example-box bad">
                  <div class="example-label"><i data-lucide="x-circle"></i> Too vague</div>
                  "Compare October to September."
                </div>
                <div class="example-box good">
                  <div class="example-label"><i data-lucide="check-circle"></i> Better</div>
                  "Compare Q3 2025 to Q3 2024 to account for seasonal patterns."
                </div>
              </div>
            </div>
          </div>
        </div>

        <a href="#ctqBuilder" onclick="navigateTo('ctqBuilder')" class="link-card" style="margin-bottom: 20px;">
          <div class="link-card-icon"><i data-lucide="git-branch"></i></div>
          <div class="link-card-content">
            <strong>CTQ Tree Builder</strong>
            <span>Translate Voice of Customer into Critical-to-Quality requirements before analysis</span>
          </div>
          <div class="link-card-arrow"><i data-lucide="arrow-right"></i></div>
        </a>

        <div class="card">
          <h3>Document Before Analysis</h3>
          <p><strong>Hypotheses:</strong> Write down what you expect to find and why. This creates accountability and prevents post-hoc rationalization.</p>

          <h4 style="margin-top: 20px;"><i data-lucide="alert-triangle" style="width:16px; height:16px; color:var(--amber); vertical-align: middle; margin-right: 6px;"></i>Potential Biases to Watch</h4>
          <div class="bias-grid">
            <div class="bias-card">
              <strong>Anchoring</strong>
              <p>Over-relying on last year's headcount or initial numbers as reference points</p>
            </div>
            <div class="bias-card">
              <strong>Recency</strong>
              <p>Overweighting recent difficult weeks while ignoring longer-term patterns</p>
            </div>
            <div class="bias-card">
              <strong>Availability</strong>
              <p>Focusing on memorable challenging claims that come easily to mind</p>
            </div>
            <div class="bias-card">
              <strong>Confirmation</strong>
              <p>Seeking data that supports standard processes while ignoring contradictions</p>
            </div>
            <div class="bias-card">
              <strong>Sunflower</strong>
              <p>Junior team members deferring to senior leaders instead of questioning assumptions</p>
            </div>
          </div>
        </div>
      `,
      
      phase2: () => `
        <div class="callout"><strong>Why it matters:</strong> Bad data in means bad decisions out. Taking time to verify your data sources prevents hours of rework and protects against flawed conclusions.</div>

        <div class="principle-box">
          <div class="principle-box-icon"><i data-lucide="shield-check"></i></div>
          <div class="principle-box-content">
            <strong>Key Principle</strong>
            <p>Always start with certified, governed datasets rather than creating custom extractions. These have been validated for accuracy and include proper quality controls.</p>
          </div>
        </div>

        <div class="card">
          <h3>Use Consistent Time Periods</h3>
          <div class="practice-grid">
            <div class="practice-card">
              <div class="practice-card-icon"><i data-lucide="calendar-check"></i></div>
              <div class="practice-card-content">
                <strong>Year-over-Year</strong>
                <span>Always compare identical periods (Q3 2025 vs Q3 2024)</span>
              </div>
            </div>
            <div class="practice-card">
              <div class="practice-card-icon"><i data-lucide="calendar-range"></i></div>
              <div class="practice-card-content">
                <strong>Minimum Period</strong>
                <span>Never analyze less than one complete month</span>
              </div>
            </div>
            <div class="practice-card">
              <div class="practice-card-icon"><i data-lucide="trending-up"></i></div>
              <div class="practice-card-content">
                <strong>Seasonal Adjustments</strong>
                <span>Use 12-month moving averages when trending</span>
              </div>
            </div>
          </div>

          <h3>Data Extraction Checklist</h3>
          <div class="checklist-grid">
            <div class="checklist-item"><i data-lucide="square-check"></i> Verified most recent data refresh timestamp</div>
            <div class="checklist-item"><i data-lucide="square-check"></i> Documented exact filters applied</div>
            <div class="checklist-item"><i data-lucide="square-check"></i> Recorded sample size</div>
            <div class="checklist-item"><i data-lucide="square-check"></i> Noted data quality warnings</div>
            <div class="checklist-item"><i data-lucide="square-check"></i> Saved extraction parameters</div>
          </div>
        </div>

        <a href="#sampleCalc" onclick="navigateTo('sampleCalc')" class="link-card" style="margin-bottom: 20px;">
          <div class="link-card-icon"><i data-lucide="calculator"></i></div>
          <div class="link-card-content">
            <strong>Sample Size Calculator</strong>
            <span>Verify your sample size is sufficient for statistically valid conclusions</span>
          </div>
          <div class="link-card-arrow"><i data-lucide="arrow-right"></i></div>
        </a>

        <div class="card">
          <h3>Common Extraction Errors</h3>
          <p class="muted" style="margin-bottom: 12px;">Watch out for these frequent mistakes that can invalidate your analysis:</p>
          <div class="error-list">
            <div class="error-card">
              <i data-lucide="alert-triangle"></i>
              <div class="error-card-content">
                <strong>Mixing Date Fields</strong>
                <p>Be explicit about claim submission date vs triage date. Using inconsistent date fields creates false trends.</p>
              </div>
            </div>
            <div class="error-card">
              <i data-lucide="alert-triangle"></i>
              <div class="error-card-content">
                <strong>Ignoring Claim Status</strong>
                <p>Including pending claims can distort analysis. Always filter to closed/completed claims unless tracking pipeline.</p>
              </div>
            </div>
            <div class="error-card">
              <i data-lucide="alert-triangle"></i>
              <div class="error-card-content">
                <strong>Overlooking Client Rules</strong>
                <p>Client implementations may affect aggregate metrics. Segment by client or document known variations.</p>
              </div>
            </div>
          </div>
        </div>
      `,
      
      phase3: () => `
        <div class="callout"><strong>Why it matters:</strong> Analysis without context is just numbers. Your interpretation determines whether decisions help or harm. Take time to understand what the data actually means.</div>

        <div class="principle-box">
          <div class="principle-box-icon"><i data-lucide="search"></i></div>
          <div class="principle-box-content">
            <strong>Core Goal</strong>
            <p>Not to confirm what you expected, but to understand what is true.</p>
          </div>
        </div>

        <div class="card">
          <div class="principle-header">
            <div class="principle-number">1</div>
            <h3 style="color: var(--brand-2);">Context is Mandatory</h3>
          </div>
          <p class="muted" style="margin-bottom: 12px;">Every metric needs at least one of these context types to be meaningful:</p>
          <div class="context-grid">
            <div class="context-card">
              <div class="context-card-header">
                <i data-lucide="history"></i>
                <strong>Historical</strong>
              </div>
              <p>"AHT increased 10% from 28 to 30.8 minutes, the highest since Q1 2024."</p>
            </div>
            <div class="context-card">
              <div class="context-card-header">
                <i data-lucide="target"></i>
                <strong>Benchmark</strong>
              </div>
              <p>"AHT of 30.8 minutes exceeds our 28-minute target but remains within industry standard of 32 minutes."</p>
            </div>
            <div class="context-card">
              <div class="context-card-header">
                <i data-lucide="git-branch"></i>
                <strong>Causal</strong>
              </div>
              <p>"AHT increase coincides with three new clients requiring complex medical records review."</p>
            </div>
            <div class="context-card">
              <div class="context-card-header">
                <i data-lucide="git-compare"></i>
                <strong>Comparative</strong>
              </div>
              <p>"AHT increased 10% while claim complexity increased 15%."</p>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="principle-header">
            <div class="principle-number">2</div>
            <h3 style="color: var(--brand-2);">Statistical vs Practical Significance</h3>
          </div>
          <p>Use the <a href="#sampleCalc" onclick="navigateTo('sampleCalc')" style="color:var(--brand)">Sample Size Calculator</a> to determine if your sample supports your conclusions.</p>

          <table class="threshold-table" style="margin-top: 16px;">
            <thead>
              <tr>
                <th>Metric</th>
                <th><span class="threshold-normal">Normal</span></th>
                <th><span class="threshold-warning">Investigate</span></th>
                <th><span class="threshold-action">Action Required</span></th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>Claims/Specialist</strong></td>
                <td><span class="threshold-normal">±5%</span></td>
                <td><span class="threshold-warning">5-10%</span></td>
                <td><span class="threshold-action">10%+</span></td>
              </tr>
              <tr>
                <td><strong>TAT (Turnaround)</strong></td>
                <td><span class="threshold-normal">±1 day</span></td>
                <td><span class="threshold-warning">1-2 days</span></td>
                <td><span class="threshold-action">2+ days</span></td>
              </tr>
              <tr>
                <td><strong>Accuracy</strong></td>
                <td><span class="threshold-normal">&lt;0.5%</span></td>
                <td><span class="threshold-warning">0.5-1%</span></td>
                <td><span class="threshold-action">1-2%*</span></td>
              </tr>
            </tbody>
          </table>
          <p class="muted" style="font-size: 12px; margin-top: 8px;">*Even small accuracy changes can be significant given 95%+ baseline</p>
        </div>

        <div class="card">
          <div class="principle-header">
            <div class="principle-number">3</div>
            <h3 style="color: var(--brand-2);">Account for Seasonality</h3>
          </div>
          <p class="muted" style="margin-bottom: 12px;">Understand typical patterns before attributing changes to other factors:</p>
          <div class="season-timeline">
            <div class="season-item surge">
              <div class="season-month">Jan</div>
              <div class="season-label">New year surge</div>
            </div>
            <div class="season-item baseline">
              <div class="season-month">Feb</div>
              <div class="season-label">Normalizing</div>
            </div>
            <div class="season-item baseline">
              <div class="season-month">Mar–Apr</div>
              <div class="season-label">Spring normal</div>
            </div>
            <div class="season-item baseline">
              <div class="season-month">May–Jun</div>
              <div class="season-label">Baseline</div>
            </div>
            <div class="season-item uptick">
              <div class="season-month">Jul–Aug</div>
              <div class="season-label">Summer uptick</div>
            </div>
            <div class="season-item baseline">
              <div class="season-month">Sep–Oct</div>
              <div class="season-label">Return to baseline</div>
            </div>
            <div class="season-item uptick">
              <div class="season-month">Nov</div>
              <div class="season-label">Holiday uptick</div>
            </div>
            <div class="season-item low">
              <div class="season-month">Dec</div>
              <div class="season-label">Year-end low</div>
            </div>
          </div>
        </div>

        <a href="#challengeMode" onclick="navigateTo('challengeMode')" class="link-card">
          <div class="link-card-icon"><i data-lucide="swords"></i></div>
          <div class="link-card-content">
            <strong>Challenge My Analysis</strong>
            <span>Get devil's advocate questions to stress-test your conclusions</span>
          </div>
          <div class="link-card-arrow"><i data-lucide="arrow-right"></i></div>
        </a>
      `,
      
      phase4: () => `
        <div class="callout"><strong>Why it matters:</strong> Cognitive biases are invisible to the person who has them. This checklist forces you to actively look for blind spots before they undermine your analysis.</div>

        <a href="#biasChecker" onclick="navigateTo('biasChecker')" class="link-card" style="margin-bottom: 20px;">
          <div class="link-card-icon"><i data-lucide="check-circle"></i></div>
          <div class="link-card-content">
            <strong>Bias Self-Check Tool</strong>
            <span>Interactive version with progress tracking and exportable results</span>
          </div>
          <div class="link-card-arrow"><i data-lucide="arrow-right"></i></div>
        </a>

        <div class="card">
          <div class="bias-category">
            <div class="bias-header">
              <div class="bias-icon cherry"><i data-lucide="scissors"></i></div>
              <div class="bias-header-content">
                <h4>Cherry-Picking Detection</h4>
                <p>Selectively presenting only favorable data</p>
              </div>
            </div>
            <div class="bias-questions">
              <div class="bias-question"><i data-lucide="help-circle"></i> Did I examine all relevant time periods or only favorable ones?</div>
              <div class="bias-question"><i data-lucide="help-circle"></i> Am I reporting all key metrics or only positive performance?</div>
              <div class="bias-question"><i data-lucide="help-circle"></i> Have I included data that contradicts my hypothesis?</div>
            </div>
          </div>

          <div class="bias-category">
            <div class="bias-header">
              <div class="bias-icon confirm"><i data-lucide="thumbs-up"></i></div>
              <div class="bias-header-content">
                <h4>Confirmation Bias Detection</h4>
                <p>Seeking evidence that supports existing beliefs</p>
              </div>
            </div>
            <div class="bias-questions">
              <div class="bias-question"><i data-lucide="help-circle"></i> Did I define my hypothesis before seeing the data?</div>
              <div class="bias-question"><i data-lucide="help-circle"></i> Have I actively sought disconfirming evidence?</div>
              <div class="bias-question"><i data-lucide="help-circle"></i> Have I considered alternative explanations?</div>
            </div>
          </div>

          <div class="bias-category">
            <div class="bias-header">
              <div class="bias-icon sample"><i data-lucide="users"></i></div>
              <div class="bias-header-content">
                <h4>Sample Size Bias Detection</h4>
                <p>Drawing conclusions from insufficient data</p>
              </div>
            </div>
            <div class="bias-questions">
              <div class="bias-question"><i data-lucide="help-circle"></i> Does my sample meet minimum thresholds?</div>
              <div class="bias-question"><i data-lucide="help-circle"></i> Have I calculated confidence intervals?</div>
              <div class="bias-question"><i data-lucide="help-circle"></i> Am I comparing groups with vastly different sizes?</div>
            </div>
          </div>

          <div class="bias-category">
            <div class="bias-header">
              <div class="bias-icon recency"><i data-lucide="anchor"></i></div>
              <div class="bias-header-content">
                <h4>Recency & Anchoring Bias</h4>
                <p>Overweighting recent events or initial reference points</p>
              </div>
            </div>
            <div class="bias-questions">
              <div class="bias-question"><i data-lucide="help-circle"></i> Am I overweighting recent experiences?</div>
              <div class="bias-question"><i data-lucide="help-circle"></i> Am I overly influenced by historical baselines?</div>
              <div class="bias-question"><i data-lucide="help-circle"></i> Have I questioned whether historical performance is appropriate?</div>
            </div>
          </div>
        </div>
      `,
      
      phase5: () => `
        <div class="callout"><strong>Why it matters:</strong> A decision without documentation is just an opinion. A decision without controls will regress. This phase ensures your analysis drives lasting change.</div>

        <a href="#decisionTemplate" onclick="navigateTo('decisionTemplate')" class="link-card" style="margin-bottom: 20px;">
          <div class="link-card-icon"><i data-lucide="file-text"></i></div>
          <div class="link-card-content">
            <strong>Decision Template Generator</strong>
            <span>Create professional documentation combining DMAIC Improve and Control stages</span>
          </div>
          <div class="link-card-arrow"><i data-lucide="arrow-right"></i></div>
        </a>

        <div class="card">
          <div class="part-header">
            <span class="part-badge improve">Part A</span>
            <h3>Improve — Decision Documentation</h3>
          </div>
          <div class="doc-fields">
            <div class="doc-field">
              <h4><i data-lucide="clipboard-list"></i> Decision Summary</h4>
              <p>Decision, Decision-Maker, Date, Implementation Timeline</p>
            </div>
            <div class="doc-field">
              <h4><i data-lucide="search"></i> Analysis Foundation</h4>
              <p>Primary Finding, Supporting Evidence, Confidence Level (High/Medium/Low)</p>
            </div>
            <div class="doc-field">
              <h4><i data-lucide="help-circle"></i> Decision Rationale</h4>
              <p>Why this decision? Why now? Alternatives considered?</p>
            </div>
            <div class="doc-field">
              <h4><i data-lucide="shield-alert"></i> Risks and Monitoring</h4>
              <p>Key risks, success metrics, monitoring plan, expected impact</p>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="part-header">
            <span class="part-badge control">Part B</span>
            <h3>Control — Sustaining the Gains</h3>
          </div>
          <p class="muted" style="margin-bottom: 16px;">Without proper controls, performance typically regresses to pre-improvement levels within 6-12 months.</p>

          <h4 style="display: flex; align-items: center; gap: 8px;"><i data-lucide="activity" style="width:16px; height:16px; color:var(--brand);"></i> Statistical Process Control (SPC)</h4>
          <p>Establish control limits to distinguish normal variation from signals requiring action:</p>
          <table class="threshold-table" style="margin: 12px 0;">
            <thead>
              <tr><th>Element</th><th>Description</th><th>Example</th></tr>
            </thead>
            <tbody>
              <tr><td><strong class="threshold-action">UCL</strong></td><td>Upper Control Limit (mean + 3σ)</td><td>TAT: 28 days</td></tr>
              <tr><td><strong class="threshold-normal">Target</strong></td><td>Process mean / goal</td><td>TAT: 23 days</td></tr>
              <tr><td><strong class="threshold-action">LCL</strong></td><td>Lower Control Limit (mean - 3σ)</td><td>TAT: 18 days</td></tr>
            </tbody>
          </table>
          <p class="muted" style="font-size: 12px;">Note: For metrics where lower is worse (like accuracy), LCL becomes your alert threshold.</p>

          <h4 style="display: flex; align-items: center; gap: 8px; margin-top: 20px;"><i data-lucide="bell-ring" style="width:16px; height:16px; color:var(--amber);"></i> Response Plan (OCAP)</h4>
          <p>Define Out-of-Control Action Plan triggers:</p>
          <div class="alert-grid">
            <div class="alert-card yellow">
              <div class="alert-indicator"></div>
              <div>
                <strong>Yellow Alert</strong>
                <span>One data point beyond 2σ → Monitor closely, investigate if persists</span>
              </div>
            </div>
            <div class="alert-card red">
              <div class="alert-indicator"></div>
              <div>
                <strong>Red Alert</strong>
                <span>One point beyond 3σ OR two consecutive points beyond 2σ → Immediate investigation required</span>
              </div>
            </div>
            <div class="alert-card pattern">
              <div class="alert-indicator"></div>
              <div>
                <strong>Pattern Alert</strong>
                <span>7+ consecutive points trending same direction → Process shift, investigate root cause</span>
              </div>
            </div>
          </div>

          <h4 style="display: flex; align-items: center; gap: 8px; margin-top: 20px;"><i data-lucide="list-checks" style="width:16px; height:16px; color:var(--brand);"></i> Control Plan Elements</h4>
          <div class="control-elements">
            <div class="control-element"><i data-lucide="target"></i> <strong>What:</strong> Metric(s)</div>
            <div class="control-element"><i data-lucide="user"></i> <strong>Who:</strong> Owner</div>
            <div class="control-element"><i data-lucide="calendar"></i> <strong>When:</strong> Frequency</div>
            <div class="control-element"><i data-lucide="database"></i> <strong>How:</strong> Data source</div>
            <div class="control-element"><i data-lucide="arrow-up-right"></i> <strong>Response:</strong> Escalation</div>
          </div>
        </div>

        <div class="case-study">
          <div class="case-study-header">
            <i data-lucide="lightbulb"></i>
            <h3>Example: Staffing Decision with Control Plan</h3>
          </div>
          <div class="case-study-body">
            <div class="case-study-item">
              <strong>Decision</strong>
              <span>Add 2 FTE specialists to STD team effective December 1, 2025</span>
            </div>
            <div class="case-study-item">
              <strong>Primary Finding</strong>
              <span>Capacity insufficient for sustained growth; TAT trending toward SLA threshold</span>
            </div>
            <div class="case-study-item">
              <strong>Evidence</strong>
              <span>Claims per specialist: 195 → 212 (8.7% ↑), TAT: 23.2 → 26.8 days, Utilization: 94%</span>
            </div>
            <div class="case-study-item">
              <strong>Expected Impact</strong>
              <span>TAT back to 23–24 days by Feb 2026</span>
            </div>
            <h4 style="margin: 16px 0 12px; font-size: 13px;">Control Plan</h4>
            <table class="threshold-table">
              <thead>
                <tr><th>Metric</th><th>Target</th><th>UCL</th><th>Owner</th><th>Frequency</th><th>Response if OOC</th></tr>
              </thead>
              <tbody>
                <tr><td>TAT (days)</td><td><span class="threshold-normal">23</span></td><td><span class="threshold-action">28</span></td><td>Ops Manager</td><td>Weekly</td><td>Escalate to Director; run 5 Whys</td></tr>
                <tr><td>Claims/Specialist</td><td><span class="threshold-normal">195</span></td><td><span class="threshold-action">210</span></td><td>Team Lead</td><td>Weekly</td><td>Review assignments; assess temp help</td></tr>
                <tr><td>Utilization %</td><td><span class="threshold-normal">85%</span></td><td><span class="threshold-action">92%</span></td><td>Ops Manager</td><td>Monthly</td><td>Capacity planning review</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="callout success" style="margin-top: 20px;">
          <strong>SAFe Integration:</strong> Align control reviews with your sprint cadence. Include control chart status in sprint reviews and flag out-of-control signals during daily stand-ups. Use quarterly PI planning to reset baselines and celebrate sustained improvements.
        </div>
      `,
      
      biasChecker: renderBiasChecker,
      sampleCalc: renderSampleCalc,
      decisionTemplate: renderDecisionTemplate,
      challengeMode: renderChallengeMode,
      ctqBuilder: renderCTQBuilder,
      fiveWhys: renderFiveWhys,

      businessUsers: () => `
        <div class="card">
          <p><strong>Your Primary Role:</strong> Consume reports and dashboards to inform day-to-day operational decisions. Interpret accurately and know when to escalate.</p>
        </div>
        
        <div class="card">
          <h3>When to Self-Serve</h3>
          <ul>
            <li>Routine KPI monitoring</li>
            <li>Compare to targets or prior periods</li>
            <li>Basic filtering in dashboards</li>
            <li>Standard report generation</li>
          </ul>
          
          <h3>When to Escalate</h3>
          <ul>
            <li>Need custom analysis</li>
            <li>Unsure about sample sizes</li>
            <li>Need statistical validation</li>
            <li>Resource-impacting decisions</li>
            <li>Inconsistent or conflicting metrics</li>
          </ul>
        </div>
      `,
      
      analysts: () => `
        <div class="card">
          <p><strong>Your Primary Role:</strong> Conduct analyses, support business questions, design reports, and ensure rigor in team decisions.</p>
        </div>
        
        <div class="card">
          <h3>Advanced Competencies</h3>
          <ul>
            <li>Statistical reasoning (CI, hypothesis tests, SPC)</li>
            <li>Data modeling (relationships, performance, quality)</li>
            <li>Bias detection & mitigation</li>
            <li>Communication: translate, recommend, document</li>
          </ul>
        </div>
        
        <div class="card">
          <h3>Presenting Results</h3>
          <ul>
            <li>Lead with implications, not methods</li>
            <li>Show uncertainty (confidence intervals)</li>
            <li>Actionable recommendations</li>
            <li>Anticipate alternative explanations</li>
            <li>Executive summary + detailed appendix</li>
          </ul>
        </div>
      `,
      
      dataPros: () => `
        <div class="card">
          <p><strong>Your Primary Role:</strong> Architecture, advanced analytics, governance, and enabling self-service at scale.</p>
        </div>
        
        <div class="card">
          <h3>Implementation Priorities</h3>
          <ol>
            <li><strong>Make the right thing easy</strong> — YoY defaults, auto CIs, surface data quality warnings</li>
            <li><strong>Build guardrails, not roadblocks</strong> — flexibility with safe defaults</li>
            <li><strong>Enable learning through doing</strong> — contextual help, celebrate good examples</li>
            <li><strong>Monitor & optimize</strong> — usage analytics, pain points, iteration</li>
          </ol>
        </div>
      `,
      
      sampleSize: () => `
        <div class="callout info">For interactive calculations, use the <a href="#sampleCalc" onclick="navigateTo('sampleCalc')" style="color:var(--brand)">Sample Size Calculator</a>.</div>
        
        <div class="card">
          <h3>When Sample Size is Insufficient</h3>
          
          <h4>Don't</h4>
          <ul>
            <li>Draw definitive conclusions</li>
            <li>Make resource decisions</li>
            <li>Report to clients as fact</li>
            <li>Compare groups with vastly different sizes</li>
          </ul>
          
          <h4>Do</h4>
          <ul>
            <li>Report descriptively only</li>
            <li>Use language like "Early indicators suggest…"</li>
            <li>Calculate and report confidence intervals</li>
            <li>Flag need for additional data</li>
          </ul>
        </div>
      `,
      
      dosDonts: () => `
        <div class="card">
          <h3>✓ Do</h3>
          <ul>
            <li><strong>Document filters</strong> — date ranges, segments, other filters</li>
            <li><strong>Check refresh timestamp</strong> — use most recent data</li>
            <li><strong>Save extraction parameters</strong> — reproducibility</li>
            <li><strong>Use YoY comparisons</strong> — avoid seasonality traps</li>
            <li><strong>Limit to 2–3 visualizations</strong> per dashboard</li>
          </ul>
        </div>
        
        <div class="card">
          <h3>✗ Don't</h3>
          <ul>
            <li>Build custom extractions solo</li>
            <li>Mix date fields (submission vs decision)</li>
            <li>Compare non-equivalent periods without adjustment</li>
            <li>Include pending claims in accuracy calculations</li>
            <li>Load >1M data points per dashboard</li>
            <li>Use excessive filters (each = query)</li>
          </ul>
        </div>
      `
    };

    // ===============================
    // HERO METADATA
    // ===============================
    const heroMeta = {
      overview: { icon: 'home', title: 'Framework Overview', tag: 'Start with questions, not data — drive continuous improvement through evidence.' },
      phase1: { icon: 'target', title: 'Phase 1 · Define', tag: 'SMART questions, CTQ requirements, and bias awareness set the path.' },
      phase2: { icon: 'database', title: 'Phase 2 · Measure', tag: 'Certified sources, consistent periods, documented filters.' },
      phase3: { icon: 'line-chart', title: 'Phase 3 · Analyze', tag: 'Context, significance, root cause, and seasonality — always.' },
      phase4: { icon: 'shield-check', title: 'Phase 4 · Bias Detection', tag: 'Seek disconfirming evidence and challenge anchors.' },
      phase5: { icon: 'file-check-2', title: 'Phase 5 · Improve & Control', tag: 'Document rationale, set control limits, monitor performance.' },
      biasChecker: { icon: 'check-circle', title: 'Bias Self-Check', tag: 'Interactive checklist with progress tracking.' },
      sampleCalc: { icon: 'calculator', title: 'Sample Size Calculator', tag: 'Calculate confidence intervals and assess precision.' },
      decisionTemplate: { icon: 'file-text', title: 'Decision Template', tag: 'Generate professional decision documentation.' },
      challengeMode: { icon: 'swords', title: 'Challenge My Analysis', tag: 'Devil\'s advocate questions to stress-test conclusions.' },
      ctqBuilder: { icon: 'git-branch', title: 'CTQ Tree Builder', tag: 'Translate Voice of Customer into measurable requirements.' },
      fiveWhys: { icon: 'help-circle', title: '5 Whys Analysis', tag: 'Drill down from symptoms to root causes.' },
      businessUsers: { icon: 'briefcase', title: 'Business Users', tag: 'Know when to self-serve and when to escalate.' },
      analysts: { icon: 'flask-conical', title: 'Analysts', tag: 'Analysis craft and bias-aware workflows.' },
      dataPros: { icon: 'settings-2', title: 'Data Professionals', tag: 'Governance, performance, and bias-resistant defaults.' },
      sampleSize: { icon: 'ruler', title: 'Sample Size Guide', tag: 'Confidence scales with n — mind your intervals.' },
      dosDonts: { icon: 'list-checks', title: "Do's & Don'ts", tag: 'Clarity, consistency, performance.' }
    };

    // ===============================
    // NAVIGATION & RENDERING
    // ===============================
    function navItems() { return Array.from(document.querySelectorAll('[data-target]')); }
    
    function setActive(key) {
      document.querySelectorAll('[data-target]').forEach(a => a.classList.remove('active'));
      const el = document.querySelector(`[data-target="${key}"]`);
      if (el) {
        el.classList.add('active');
        // Ensure parent section is open
        const nav = el.closest('.subnav');
        if (nav) {
          const btn = nav.previousElementSibling;
          if (btn?.getAttribute('aria-expanded') === 'false') toggleSection(btn);
        }
      }
    }

    function setHero(key) {
      const meta = heroMeta[key] || heroMeta['overview'];
      document.getElementById('heroTitle').textContent = meta.title;
      document.getElementById('heroTag').textContent = meta.tag;
      document.getElementById('heroIcon').setAttribute('data-lucide', meta.icon);
      document.getElementById('crumbs').lastElementChild.textContent = meta.title;
      renderIcons();
    }

    function renderView(key) {
      const content = document.getElementById('content');
      const viewFn = views[key] || views['overview'];
      const markup = typeof viewFn === 'function' ? viewFn() : viewFn;
      
      content.innerHTML = '';
      const section = document.createElement('section');
      section.className = 'fade-in';
      section.innerHTML = markup;
      content.appendChild(section);
      
      setHero(key);
      setActive(key);
      
      if (history.pushState) history.pushState(null, '', '#' + key);
      else location.hash = '#' + key;
      
      content.focus();
      renderIcons();
      
      // Initialize calculator if on that page
      if (key === 'sampleCalc') {
        setTimeout(calculateCI, 50);
      }

      // Initialize CTQ Builder if on that page
      if (key === 'ctqBuilder') {
        setTimeout(initCTQ, 50);
      }

      // Initialize 5 Whys if on that page
      if (key === 'fiveWhys') {
        setTimeout(initFiveWhys, 50);
      }

      // Re-highlight search if active
      const q = document.getElementById('q');
      if (q?.value) highlight(q.value.toLowerCase());
      
      // Scroll to top
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          window.scrollTo({ top: 0, behavior: 'auto' });
        });
      });
    }

    function navigateTo(key) {
      renderView(key);
      document.getElementById('leftNav').classList.remove('open');
    }

    function copyLink() {
      const url = location.origin + location.pathname + location.search + location.hash;
      navigator.clipboard?.writeText(url).then(() => toast('Link copied')).catch(() => {});
    }
    
    function toast(msg) {
      const t = document.createElement('div');
      t.textContent = msg;
      Object.assign(t.style, {
        position: 'fixed', bottom: '20px', right: '20px',
        background: 'var(--panel)', color: 'var(--text)',
        padding: '10px 16px', border: '1px solid var(--border)',
        borderRadius: '10px', boxShadow: 'var(--shadow-md)', zIndex: 99,
        fontFamily: 'var(--font-display)', fontSize: '14px'
      });
      document.body.appendChild(t);
      setTimeout(() => {
        t.style.transition = 'opacity .25s';
        t.style.opacity = '0';
        setTimeout(() => t.remove(), 300);
      }, 1500);
    }

    function wireNav() {
      navItems().forEach(el => el.addEventListener('click', (e) => {
        e.preventDefault();
        navigateTo(el.getAttribute('data-target'));
      }));
    }

    function init() {
      const saved = localStorage.getItem(themeKey);
      applyTheme(saved || 'light');
      wireNav();
      renderIcons();
      const initial = (location.hash || '#overview').slice(1);
      navigateTo(initial in views ? initial : 'overview');
    }
    
    window.addEventListener('hashchange', () => {
      const k = (location.hash || '#overview').replace('#', '');
      if (k in views) navigateTo(k);
    });
    
    init();
  </script>
</body>
</html>
